<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Viajeros âœˆï¸</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,wght@0,300;0,600;0,800;1,300&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
  :root {
    --bg: #0a0c10;
    --surface: #111318;
    --surface2: #191d26;
    --surface3: #1f2535;
    --border: rgba(255,255,255,0.07);
    --accent: #e8c97a;
    --accent2: #5b8cf7;
    --accent3: #7cefb0;
    --danger: #f07878;
    --text: #f0ede6;
    --text2: #8a8fa3;
    --text3: #5a5f73;
    --radius: 16px;
    --radius-sm: 10px;
    --shadow: 0 8px 40px rgba(0,0,0,0.5);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  
  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Fondo animado */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: 
      radial-gradient(ellipse 80% 50% at 20% -10%, rgba(91,140,247,0.12) 0%, transparent 60%),
      radial-gradient(ellipse 60% 40% at 80% 110%, rgba(232,201,122,0.08) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  /* â”€â”€â”€ AUTH SCREEN â”€â”€â”€ */
  #auth-screen {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    padding: 20px;
  }

  .auth-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 48px 40px;
    width: 100%;
    max-width: 420px;
    box-shadow: var(--shadow);
    animation: slideUp 0.5s ease;
  }

  .auth-logo {
    text-align: center;
    margin-bottom: 32px;
  }

  .auth-logo h1 {
    font-family: 'Fraunces', serif;
    font-size: 2.4rem;
    font-weight: 800;
    color: var(--accent);
    letter-spacing: -1px;
  }

  .auth-logo p {
    color: var(--text2);
    font-size: 0.9rem;
    margin-top: 4px;
  }

  .auth-tabs {
    display: flex;
    background: var(--surface2);
    border-radius: var(--radius-sm);
    padding: 4px;
    margin-bottom: 28px;
  }

  .auth-tab {
    flex: 1;
    padding: 10px;
    text-align: center;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text2);
    transition: all 0.2s;
  }

  .auth-tab.active {
    background: var(--surface3);
    color: var(--text);
  }

  .form-group { margin-bottom: 16px; }

  .form-group label {
    display: block;
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--text2);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  input, textarea, select {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px 16px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.95rem;
    outline: none;
    transition: border-color 0.2s;
  }

  input:focus, textarea:focus, select:focus {
    border-color: rgba(91,140,247,0.4);
  }

  select option { background: var(--surface2); }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 24px;
    border-radius: var(--radius-sm);
    border: none;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.95rem;
    font-weight: 600;
    transition: all 0.2s;
    text-decoration: none;
  }

  .btn-primary {
    background: var(--accent);
    color: #0a0c10;
    width: 100%;
  }

  .btn-primary:hover { background: #f0d48a; transform: translateY(-1px); }

  .btn-ghost {
    background: transparent;
    color: var(--text2);
    border: 1px solid var(--border);
  }

  .btn-ghost:hover { background: var(--surface2); color: var(--text); }

  .btn-danger {
    background: rgba(240,120,120,0.15);
    color: var(--danger);
    border: 1px solid rgba(240,120,120,0.2);
  }

  .btn-sm { padding: 8px 16px; font-size: 0.85rem; }

  /* â”€â”€â”€ MAIN APP â”€â”€â”€ */
  #app { display: none; position: relative; z-index: 1; }

  /* â”€â”€â”€ TOP NAV â”€â”€â”€ */
  .topnav {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 50;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 24px;
    background: rgba(10,12,16,0.85);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
  }

  .nav-brand {
    font-family: 'Fraunces', serif;
    font-size: 1.4rem;
    font-weight: 800;
    color: var(--accent);
    letter-spacing: -0.5px;
  }

  .nav-user {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent2), var(--accent));
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.85rem;
    color: #fff;
    flex-shrink: 0;
  }

  .avatar-lg {
    width: 48px;
    height: 48px;
    font-size: 1rem;
  }

  /* â”€â”€â”€ MAIN CONTENT â”€â”€â”€ */
  .main-content {
    padding-top: 80px;
    min-height: 100vh;
  }

  /* â”€â”€â”€ HOME / GROUPS â”€â”€â”€ */
  #home-view {
    padding: 32px 24px;
    max-width: 800px;
    margin: 0 auto;
  }

  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
  }

  .section-title {
    font-family: 'Fraunces', serif;
    font-size: 1.6rem;
    font-weight: 600;
    color: var(--text);
  }

  .section-subtitle {
    color: var(--text2);
    font-size: 0.9rem;
    margin-top: 4px;
  }

  .trip-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 16px;
    cursor: pointer;
    transition: all 0.25s;
    position: relative;
  }

  .trip-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--accent2), var(--accent));
    opacity: 0;
    transition: opacity 0.25s;
  }

  .trip-card:hover {
    border-color: rgba(91,140,247,0.3);
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(0,0,0,0.3);
  }

  .trip-card:hover::before { opacity: 1; }

  .trip-card-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 12px;
  }

  .trip-emoji {
    font-size: 2rem;
    width: 52px;
    height: 52px;
    background: var(--surface2);
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .trip-info { flex: 1; }

  .trip-name {
    font-family: 'Fraunces', serif;
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 4px;
  }

  .trip-meta {
    display: flex;
    gap: 16px;
    color: var(--text2);
    font-size: 0.85rem;
  }

  .badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.78rem;
    font-weight: 600;
  }

  .badge-blue { background: rgba(91,140,247,0.15); color: var(--accent2); }
  .badge-gold { background: rgba(232,201,122,0.15); color: var(--accent); }
  .badge-green { background: rgba(124,239,176,0.15); color: var(--accent3); }
  .badge-red { background: rgba(240,120,120,0.15); color: var(--danger); }

  /* â”€â”€â”€ TRIP DETAIL â”€â”€â”€ */
  #trip-view {
    display: none;
    max-width: 900px;
    margin: 0 auto;
    padding: 32px 24px;
  }

  .back-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: var(--text2);
    cursor: pointer;
    font-size: 0.9rem;
    margin-bottom: 24px;
    transition: color 0.2s;
  }

  .back-btn:hover { color: var(--text); }

  .trip-hero {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 28px;
    margin-bottom: 24px;
  }

  .trip-hero-top {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 20px;
  }

  .trip-hero-info h2 {
    font-family: 'Fraunces', serif;
    font-size: 1.8rem;
    font-weight: 700;
  }

  .trip-hero-info p { color: var(--text2); font-size: 0.9rem; margin-top: 4px; }

  .members-row {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .member-chip {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 30px;
    padding: 6px 12px;
    font-size: 0.85rem;
  }

  .tabs {
    display: flex;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 6px;
    margin-bottom: 24px;
    gap: 4px;
  }

  .tab {
    flex: 1;
    padding: 10px 16px;
    text-align: center;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text2);
    transition: all 0.2s;
  }

  .tab.active {
    background: var(--surface2);
    color: var(--text);
  }

  /* â”€â”€â”€ EXPENSE CARDS â”€â”€â”€ */
  .expense-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px 24px;
    margin-bottom: 12px;
    transition: all 0.2s;
  }

  .expense-card:hover { border-color: rgba(255,255,255,0.12); }

  .expense-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 12px;
  }

  .expense-icon {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    flex-shrink: 0;
  }

  .expense-details { flex: 1; }

  .expense-title {
    font-weight: 600;
    font-size: 1rem;
    margin-bottom: 4px;
  }

  .expense-meta {
    display: flex;
    gap: 12px;
    font-size: 0.82rem;
    color: var(--text2);
    flex-wrap: wrap;
  }

  .expense-amount {
    text-align: right;
  }

  .expense-amount .total {
    font-family: 'Fraunces', serif;
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--accent);
  }

  .expense-amount .per-person {
    font-size: 0.82rem;
    color: var(--text2);
  }

  /* Payment confirmations */
  .payments-section {
    margin-top: 14px;
    padding-top: 14px;
    border-top: 1px solid var(--border);
  }

  .payments-label {
    font-size: 0.78rem;
    font-weight: 600;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 10px;
  }

  .payment-pills {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .payment-pill {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.82rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid transparent;
  }

  /* Estados: unpaid â†’ claimed (amarillo) â†’ confirmed (verde) */
  .payment-pill.unpaid {
    background: var(--surface2);
    color: var(--text2);
    border-color: var(--border);
  }
  .payment-pill.unpaid:hover {
    border-color: rgba(232,201,122,0.4);
    color: var(--accent);
  }
  .payment-pill.claimed {
    background: rgba(232,201,122,0.15);
    color: var(--accent);
    border-color: rgba(232,201,122,0.35);
    cursor: default;
  }
  .payment-pill.claimed.can-confirm {
    cursor: pointer;
  }
  .payment-pill.claimed.can-confirm:hover {
    background: rgba(124,239,176,0.15);
    color: var(--accent3);
    border-color: rgba(124,239,176,0.3);
  }
  .payment-pill.confirmed {
    background: rgba(124,239,176,0.15);
    color: var(--accent3);
    border-color: rgba(124,239,176,0.2);
    cursor: default;
  }
  .payment-pill .pill-icon { font-size: 0.9rem; }

  /* â”€â”€â”€ BALANCE SECTION â”€â”€â”€ */
  .balance-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 16px;
  }

  .balance-person {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 0;
    border-bottom: 1px solid var(--border);
  }

  .balance-person:last-child { border-bottom: none; }

  .balance-left { display: flex; align-items: center; gap: 12px; }

  .balance-amount {
    font-family: 'Fraunces', serif;
    font-size: 1.2rem;
    font-weight: 600;
  }

  .balance-positive { color: var(--accent3); }
  .balance-negative { color: var(--danger); }
  .balance-neutral { color: var(--text2); }

  /* â”€â”€â”€ MODAL â”€â”€â”€ */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(8px);
    z-index: 200;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    padding: 0;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
  }

  .modal-overlay.show {
    opacity: 1;
    pointer-events: all;
  }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 24px 24px 0 0;
    padding: 32px 28px;
    width: 100%;
    max-width: 560px;
    max-height: 90vh;
    overflow-y: auto;
    transform: translateY(100%);
    transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: 0 -20px 60px rgba(0,0,0,0.5);
  }

  .modal-overlay.show .modal {
    transform: translateY(0);
  }

  .modal-handle {
    width: 40px;
    height: 4px;
    background: var(--surface3);
    border-radius: 2px;
    margin: 0 auto 24px;
  }

  .modal-title {
    font-family: 'Fraunces', serif;
    font-size: 1.4rem;
    font-weight: 600;
    margin-bottom: 24px;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .category-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    margin-bottom: 4px;
  }

  .cat-btn {
    padding: 10px 8px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    text-align: center;
    cursor: pointer;
    font-size: 0.8rem;
    color: var(--text2);
    transition: all 0.2s;
  }

  .cat-btn .cat-icon { font-size: 1.3rem; display: block; margin-bottom: 4px; }

  .cat-btn.selected {
    background: rgba(91,140,247,0.15);
    border-color: rgba(91,140,247,0.4);
    color: var(--accent2);
  }

  /* â”€â”€â”€ MEMBERS CHECKBOXES â”€â”€â”€ */
  .members-check {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .member-check-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all 0.2s;
  }

  .member-check-item.checked {
    border-color: rgba(91,140,247,0.4);
    background: rgba(91,140,247,0.08);
  }

  .check-circle {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    flex-shrink: 0;
    transition: all 0.2s;
  }

  .member-check-item.checked .check-circle {
    background: var(--accent2);
    border-color: var(--accent2);
    color: white;
  }

  /* â”€â”€â”€ FAB â”€â”€â”€ */
  .fab {
    position: fixed;
    bottom: 28px;
    right: 24px;
    width: 58px;
    height: 58px;
    border-radius: 50%;
    background: var(--accent);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    box-shadow: 0 8px 24px rgba(232,201,122,0.3);
    transition: all 0.2s;
    z-index: 40;
    color: #0a0c10;
    font-weight: bold;
  }

  .fab:hover { transform: scale(1.1); box-shadow: 0 12px 32px rgba(232,201,122,0.4); }

  /* â”€â”€â”€ EMPTY STATE â”€â”€â”€ */
  .empty-state {
    text-align: center;
    padding: 48px 24px;
    color: var(--text3);
  }

  .empty-state .empty-icon {
    font-size: 3rem;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  .empty-state p { font-size: 1rem; color: var(--text2); }
  .empty-state small { font-size: 0.85rem; }

  /* â”€â”€â”€ INVITE CODE â”€â”€â”€ */
  .invite-box {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-top: 16px;
  }

  .invite-code {
    font-family: monospace;
    font-size: 1.2rem;
    letter-spacing: 3px;
    color: var(--accent);
    font-weight: 700;
  }

  /* â”€â”€â”€ NOTES â”€â”€â”€ */
  .note-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 12px;
  }

  .note-card .note-author {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
  }

  /* â”€â”€â”€ TOAST â”€â”€â”€ */
  .toast {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--surface3);
    border: 1px solid var(--border);
    border-radius: 30px;
    padding: 12px 24px;
    font-size: 0.9rem;
    font-weight: 500;
    z-index: 999;
    opacity: 0;
    transition: all 0.3s;
    pointer-events: none;
    white-space: nowrap;
  }

  .toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  /* â”€â”€â”€ LOADER â”€â”€â”€ */
  .loader {
    width: 20px;
    height: 20px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  .section-panel { display: none; animation: fadeIn 0.3s ease; }
  .section-panel.active { display: block; }

  /* â”€â”€â”€ SCROLLBAR â”€â”€â”€ */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 3px; }

  .divider { height: 1px; background: var(--border); margin: 20px 0; }

  .inline-flex { display: inline-flex; align-items: center; gap: 6px; }

  .text-muted { color: var(--text2); font-size: 0.85rem; }
  .text-sm { font-size: 0.85rem; }

  .flex-gap { display: flex; gap: 10px; }

  /* â”€â”€â”€ DROPDOWN MENU â”€â”€â”€ */
  .dropdown { position: relative; }
  .dropdown-menu {
    position: fixed;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: var(--radius-sm); min-width: 180px; z-index: 500;
    box-shadow: 0 8px 32px rgba(0,0,0,0.6); overflow: hidden; display: none;
  }
  .dropdown-menu.open { display: block; animation: fadeIn 0.15s ease; }
  .dropdown-item {
    display: flex; align-items: center; gap: 8px; padding: 10px 14px;
    font-size: 0.88rem; cursor: pointer; color: var(--text2); transition: background 0.15s;
  }
  .dropdown-item:hover { background: var(--surface3); color: var(--text); }
  .dropdown-item.danger { color: var(--danger); }
  .dropdown-item.danger:hover { background: rgba(240,120,120,0.1); }
  .dots-btn {
    width: 32px; height: 32px; border-radius: 8px; border: 1px solid transparent;
    background: transparent; cursor: pointer; display: flex; align-items: center;
    justify-content: center; color: var(--text2); font-size: 1.2rem;
    transition: all 0.15s; flex-shrink: 0;
  }
  .dots-btn:hover { background: var(--surface2); border-color: var(--border); color: var(--text); }

  /* â”€â”€â”€ PERSONAL TOTAL BAR â”€â”€â”€ */
  .total-bar {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 16px 20px; margin-bottom: 16px;
    display: flex; align-items: center; justify-content: space-between;
  }
  .total-bar-label { font-size: 0.85rem; color: var(--text2); }
  .total-bar-amount { font-family: 'Fraunces', serif; font-size: 1.5rem; font-weight: 700; color: var(--accent); }



  /* â”€â”€â”€ CUSTOM CONFIRM DIALOG â”€â”€â”€ */
  .confirm-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.75);
    backdrop-filter: blur(10px);
    z-index: 1000;
    display: flex; align-items: center; justify-content: center;
    padding: 24px;
    opacity: 0; pointer-events: none;
    transition: opacity 0.25s;
  }
  .confirm-overlay.show { opacity: 1; pointer-events: all; }

  .confirm-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 32px 28px;
    max-width: 360px;
    width: 100%;
    box-shadow: 0 24px 60px rgba(0,0,0,0.6);
    transform: scale(0.92);
    transition: transform 0.25s cubic-bezier(0.34,1.56,0.64,1);
    text-align: center;
  }
  .confirm-overlay.show .confirm-box { transform: scale(1); }

  .confirm-icon { font-size: 2.8rem; margin-bottom: 12px; }
  .confirm-title {
    font-family: 'Fraunces', serif;
    font-size: 1.3rem; font-weight: 700;
    margin-bottom: 8px;
  }
  .confirm-msg { color: var(--text2); font-size: 0.9rem; line-height: 1.5; margin-bottom: 24px; }
  .confirm-actions { display: flex; gap: 10px; }
  .confirm-actions .btn { flex: 1; }


  /* â”€â”€â”€ LIGHTBOX â”€â”€â”€ */
  .lightbox-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.92);
    z-index: 2000;
    display: flex; align-items: center; justify-content: center;
    padding: 20px;
    opacity: 0; pointer-events: none;
    transition: opacity 0.25s;
    cursor: zoom-out;
  }
  .lightbox-overlay.show { opacity: 1; pointer-events: all; }
  .lightbox-overlay img {
    max-width: 100%; max-height: 90vh;
    border-radius: 12px;
    box-shadow: 0 24px 60px rgba(0,0,0,0.8);
    transform: scale(0.9);
    transition: transform 0.25s cubic-bezier(0.34,1.56,0.64,1);
  }
  .lightbox-overlay.show img { transform: scale(1); }
  .lightbox-close {
    position: absolute; top: 16px; right: 16px;
    width: 36px; height: 36px;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 50%;
    color: white; font-size: 1rem;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
  }

  /* â”€â”€â”€ PROFILE PAGE â”€â”€â”€ */
  #profile-view {
    display: none;
    max-width: 600px;
    margin: 0 auto;
    padding: 32px 24px;
  }

  .profile-hero {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 28px;
    margin-bottom: 20px;
    text-align: center;
  }

  .profile-avatar {
    width: 72px; height: 72px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent2), var(--accent));
    display: flex; align-items: center; justify-content: center;
    font-size: 1.8rem; font-weight: 700; color: #fff;
    margin: 0 auto 12px;
  }

  .profile-name {
    font-family: 'Fraunces', serif;
    font-size: 1.4rem; font-weight: 700;
  }

  .profile-email { color: var(--text2); font-size: 0.88rem; margin-top: 4px; }

  .profile-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 16px;
  }

  .profile-section-title {
    font-family: 'Fraunces', serif;
    font-size: 1rem; font-weight: 600;
    margin-bottom: 16px;
    color: var(--text2);
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 0.82rem;
  }

  /* â”€â”€â”€ BANK INFO CARD â”€â”€â”€ */
  .bank-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 16px;
    margin-bottom: 12px;
  }

  .bank-card-header {
    display: flex; align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }

  .bank-card-bank {
    font-weight: 600; font-size: 0.95rem;
  }

  .bank-card-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }

  .bank-card-field { font-size: 0.82rem; }
  .bank-card-field .field-label { color: var(--text3); margin-bottom: 2px; }
  .bank-card-field .field-value { color: var(--text); font-weight: 500; }

  .pay-info-row {
    display: flex; justify-content: space-between;
    align-items: center;
    padding: 5px 0;
    font-size: 0.85rem;
    border-bottom: 1px solid var(--border);
  }

  .pay-info-row:last-child { border-bottom: none; }
  .pay-info-row .key { color: var(--text2); }
  .pay-info-row .val { font-weight: 600; color: var(--text); }

  /* â”€â”€â”€ TRIP DATES â”€â”€â”€ */
  .trip-dates-row {
    display: flex; gap: 8px;
    align-items: center;
    margin-top: 8px;
    font-size: 0.82rem;
    color: var(--text2);
  }

  .trip-dates-row .date-badge {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 4px 10px;
    font-size: 0.8rem;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     RESPONSIVE â€” MOBILE FIRST
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  /* Bottom nav for mobile */
  .bottom-nav {
    display: none;
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: rgba(17,19,24,0.96);
    backdrop-filter: blur(20px);
    border-top: 1px solid var(--border);
    z-index: 50;
    padding: 8px 0 env(safe-area-inset-bottom, 8px);
  }

  .bottom-nav-inner {
    display: flex;
    justify-content: space-around;
    align-items: center;
    max-width: 480px;
    margin: 0 auto;
  }

  .bnav-btn {
    display: flex; flex-direction: column;
    align-items: center; gap: 3px;
    background: none; border: none;
    cursor: pointer; padding: 6px 16px;
    color: var(--text3);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.7rem; font-weight: 500;
    transition: color 0.2s;
    -webkit-tap-highlight-color: transparent;
  }

  .bnav-btn .bnav-icon { font-size: 1.3rem; }
  .bnav-btn.active { color: var(--accent); }
  .bnav-btn:active { transform: scale(0.92); }

  @media (max-width: 640px) {
    /* General */
    .form-row { grid-template-columns: 1fr; }
    .auth-card { padding: 32px 20px; border-radius: 20px; }
    .auth-logo h1 { font-size: 2rem; }

    /* Top nav simplified on mobile */
    .topnav { padding: 12px 16px; }
    .nav-brand { font-size: 1.2rem; }
    #nav-name { display: none; }

    /* Show bottom nav, hide FAB when inside trip */
    .bottom-nav { display: block; }
    .main-content { padding-top: 68px; padding-bottom: 80px; }

    /* FAB repositioned above bottom nav */
    .fab { bottom: 80px; right: 16px; width: 52px; height: 52px; font-size: 1.3rem; }

    /* Home view */
    #home-view { padding: 20px 16px; }
    .section-title { font-size: 1.3rem; }

    /* Trip cards */
    .trip-card { padding: 16px; }
    .trip-emoji { width: 44px; height: 44px; font-size: 1.4rem; border-radius: 12px; }
    .trip-name { font-size: 1rem; }
    .trip-meta { font-size: 0.78rem; gap: 8px; flex-wrap: wrap; }

    /* Trip view */
    #trip-view { padding: 16px; }
    .trip-hero { padding: 16px; margin-bottom: 16px; }
    .trip-hero-top { gap: 12px; }
    .trip-hero-info h2 { font-size: 1.3rem; }
    #tv-emoji { width: 48px !important; height: 48px !important; font-size: 1.4rem !important; border-radius: 12px; }

    /* Hide desktop tabs on mobile (use bottom nav instead) */
    .tabs { display: none; }

    /* Members row wraps nicely */
    .members-row { gap: 6px; margin-top: 12px; }
    .member-chip { font-size: 0.78rem; padding: 4px 10px; }

    /* Expense cards */
    .expense-card { padding: 14px 16px; }
    .expense-icon { width: 38px; height: 38px; font-size: 1rem; border-radius: 10px; }
    .expense-title { font-size: 0.92rem; }
    .expense-meta { font-size: 0.76rem; gap: 6px; }
    .expense-amount .total { font-size: 1.1rem; }
    .expense-amount .per-person { font-size: 0.76rem; }

    /* Payment pills */
    .payment-pill { font-size: 0.76rem; padding: 5px 10px; }

    /* Modals full width on mobile */
    .modal { padding: 24px 20px; border-radius: 20px 20px 0 0; }
    .modal-title { font-size: 1.2rem; }
    .category-grid { grid-template-columns: repeat(4, 1fr); gap: 6px; }
    .cat-btn { padding: 8px 4px; font-size: 0.72rem; }
    .cat-btn .cat-icon { font-size: 1.1rem; }

    /* Auth */
    #auth-screen { align-items: flex-end; padding: 0; }
    .auth-card { border-radius: 20px 20px 0 0; max-height: 92vh; overflow-y: auto;
      padding-bottom: calc(20px + env(safe-area-inset-bottom, 0px)); }

    /* Profile */
    #profile-view { padding: 20px 16px; }
    .profile-hero { padding: 20px; }
    .bank-card-grid { grid-template-columns: 1fr 1fr; }

    /* Balance */
    .balance-card { padding: 16px; }
    .balance-person { padding: 12px 0; }
    .balance-amount { font-size: 1rem; }
    .avatar-lg { width: 40px !important; height: 40px !important; font-size: 0.9rem !important; }

    /* Total bar */
    .total-bar { padding: 14px 16px; }
    .total-bar-amount { font-size: 1.2rem; }

    /* Notes */
    #panel-notes { padding-bottom: 16px; }
    .note-card { padding: 14px; }

    /* Invite box */
    .invite-box { flex-direction: column; align-items: flex-start; gap: 12px; }
    .invite-code { font-size: 1.5rem; letter-spacing: 4px; }

    /* Back btn */
    .back-btn { font-size: 0.88rem; margin-bottom: 16px; }

    /* Section header */
    .section-header { flex-direction: column; align-items: flex-start; gap: 12px; }
    .section-header .btn { width: 100%; justify-content: center; }
  }

  /* Safe area for notched phones */
  @supports (padding-bottom: env(safe-area-inset-bottom)) {
    .bottom-nav { padding-bottom: calc(8px + env(safe-area-inset-bottom)); }
    .fab { bottom: calc(80px + env(safe-area-inset-bottom)); }
  }
</style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="auth-screen">
  <div class="auth-card">
    <div class="auth-logo">
      <h1>âœˆ Viajeros</h1>
      <p>Gastos compartidos sin drama</p>
    </div>

    <div class="auth-tabs">
      <div class="auth-tab active" onclick="switchAuthTab('login')">Iniciar sesiÃ³n</div>
      <div class="auth-tab" onclick="switchAuthTab('register')">Registrarse</div>
    </div>

    <div id="login-form">
      <div class="form-group">
        <label>Correo electrÃ³nico</label>
        <input type="email" id="login-email" placeholder="tu@correo.com">
      </div>
      <div class="form-group">
        <label>ContraseÃ±a</label>
        <input type="password" id="login-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
      </div>
      <button class="btn btn-primary" onclick="doLogin()">Entrar al viaje â†’</button>
    </div>

    <div id="register-form" style="display:none">
      <div class="form-group">
        <label>Tu nombre</label>
        <input type="text" id="reg-name" placeholder="Pablo MuÃ±oz">
      </div>
      <div class="form-group">
        <label>Correo electrÃ³nico</label>
        <input type="email" id="reg-email" placeholder="tu@correo.com">
      </div>
      <div class="form-group">
        <label>ContraseÃ±a</label>
        <input type="password" id="reg-password" placeholder="MÃ­nimo 6 caracteres">
      </div>
      <button class="btn btn-primary" onclick="doRegister()">Crear cuenta â†’</button>
    </div>

    <div style="margin-top:16px; text-align:center">
      <p class="text-muted">Â¿Tienes un cÃ³digo de viaje?</p>
      <div style="display:flex; gap:8px; margin-top:8px">
        <input type="text" id="join-code" placeholder="CÃ³digo de 6 caracteres" style="text-transform:uppercase; letter-spacing:2px">
        <button class="btn btn-ghost btn-sm" onclick="joinByCode()" style="white-space:nowrap">Unirse</button>
      </div>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="app">
  <!-- TOP NAV -->
  <nav class="topnav">
    <div class="nav-brand">âœˆ Viajeros</div>
    <div class="nav-user">
      <div class="avatar" id="nav-avatar">?</div>
      <span id="nav-name" style="font-size:0.9rem; color:var(--text2)"></span>
      <button class="btn btn-ghost btn-sm" onclick="openProfile()">ğŸ‘¤ Perfil</button>
      <button class="btn btn-ghost btn-sm" onclick="doLogout()">Salir</button>
    </div>
  </nav>

  <div class="main-content">
    <!-- HOME VIEW -->
    <div id="home-view">
      <div class="section-header">
        <div>
          <h2 class="section-title">Mis Viajes</h2>
          <p class="section-subtitle">Tus aventuras y sus gastos</p>
        </div>
        <button class="btn btn-primary" style="width:auto" onclick="openModal('create-trip-modal')">+ Nuevo viaje</button>
      </div>
      <div id="trips-list">
        <div class="empty-state">
          <div class="empty-icon">ğŸ—ºï¸</div>
          <p>No tienes viajes aÃºn</p>
          <small>Crea uno o Ãºnete con un cÃ³digo</small>
        </div>
      </div>
    </div>

    <!-- TRIP DETAIL VIEW -->
    <div id="trip-view">
      <div class="back-btn" onclick="goHome()">â† Volver a mis viajes</div>

      <div class="trip-hero">
        <div class="trip-hero-top">
          <div class="trip-emoji" id="tv-emoji" style="font-size:1.8rem; width:60px; height:60px">âœˆï¸</div>
          <div class="trip-hero-info">
            <h2 id="tv-name">Viaje</h2>
            <p id="tv-desc"></p>
        <div class="trip-dates-row" id="tv-dates" style="display:none"></div>
          </div>
          <div style="display:flex; gap:8px; margin-left:auto">
            <button class="btn btn-ghost btn-sm" onclick="openModal('invite-modal')">ğŸ‘¥ Invitar</button>
          </div>
        </div>
        <div class="members-row" id="tv-members"></div>
      </div>

      <div class="tabs">
        <div class="tab active" onclick="switchTab('shared')">ğŸ’¸ Gastos Compartidos</div>
        <div class="tab" onclick="switchTab('personal')">ğŸ”’ Mis Gastos</div>
        <div class="tab" onclick="switchTab('balance')">âš–ï¸ Balance</div>
        <div class="tab" onclick="switchTab('notes')">ğŸ“ Notas</div>
      </div>

      <!-- SHARED EXPENSES -->
      <div class="section-panel active" id="panel-shared">
        <div id="shared-list">
          <div class="empty-state">
            <div class="empty-icon">ğŸ’¸</div>
            <p>Sin gastos compartidos aÃºn</p>
            <small>Toca + para agregar el primero</small>
          </div>
        </div>
      </div>

      <!-- PERSONAL EXPENSES -->
      <div class="section-panel" id="panel-personal">
        <div id="personal-list">
          <div class="empty-state">
            <div class="empty-icon">ğŸ”’</div>
            <p>Sin gastos personales</p>
            <small>Solo tÃº puedes verlos</small>
          </div>
        </div>
      </div>

      <!-- BALANCE -->
      <div class="section-panel" id="panel-balance">
        <div class="balance-card">
          <h3 style="font-family:'Fraunces',serif; margin-bottom:16px; color:var(--text2); font-size:1rem; text-transform:uppercase; letter-spacing:1px">Resumen de gastos</h3>
          <div id="balance-list"></div>
        </div>
        <div class="balance-card" id="owed-section" style="margin-top:16px">
          <h3 style="font-family:'Fraunces',serif; margin-bottom:16px; color:var(--text2); font-size:1rem; text-transform:uppercase; letter-spacing:1px">Â¿QuiÃ©n le debe a quiÃ©n?</h3>
          <div id="owed-list"></div>
        </div>
      </div>

      <!-- NOTES -->
      <div class="section-panel" id="panel-notes">
        <div id="notes-list"></div>
        <div style="margin-top:12px">
          <textarea id="note-input" placeholder="Agrega una nota al grupo... (itinerario, recordatorios, ideas)" style="height:80px; resize:none"></textarea>
          <button class="btn btn-primary" style="margin-top:8px; width:auto" onclick="addNote()">Publicar nota</button>
        </div>
      </div>

    <!-- DANGER ZONE -->
    <div id="trip-danger-zone" style="margin-top: 32px; padding-top: 20px; border-top: 1px solid var(--border);">
      <button id="trip-action-btn" class="btn btn-danger" style="width:100%" onclick="tripDangerAction()">
        ğŸ—‘ï¸ Eliminar viaje
      </button>
    </div>

    </div><!-- /trip-view -->

    <!-- PROFILE VIEW -->
    <div id="profile-view">
      <div class="back-btn" onclick="goHome()">â† Volver a mis viajes</div>

      <div class="profile-hero">
        <div class="profile-avatar" id="pv-avatar">?</div>
        <div class="profile-name" id="pv-name"></div>
        <div class="profile-email" id="pv-email"></div>
      </div>

      <div class="profile-section">
        <div class="profile-section-title">ğŸ’³ Datos para recibir transferencias</div>
        <div id="bank-cards-list"></div>
        <button class="btn btn-ghost" style="width:100%; margin-top:4px" onclick="openModal('bank-modal')">+ Agregar cuenta bancaria</button>
      </div>
    </div>

  </div><!-- /main-content -->

  <!-- FAB -->
  <button class="fab" id="fab-btn" onclick="openAddExpense()" title="Agregar gasto">+</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â•â•â• -->

<!-- CREATE TRIP MODAL -->
<div class="modal-overlay" id="create-trip-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2 class="modal-title">Nuevo Viaje âœˆï¸</h2>
    <div class="form-group">
      <label>Nombre del viaje</label>
      <input type="text" id="trip-name-input" placeholder="Dolomitas 2025">
    </div>
    <div class="form-group">
      <label>DescripciÃ³n</label>
      <input type="text" id="trip-desc-input" placeholder="Un viaje Ã©pico por los Alpes italianos">
    </div>
    <div class="form-group">
      <label>Emoji del viaje</label>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <span class="cat-btn selected" onclick="selectEmoji(this,'ğŸ”ï¸')"><span class="cat-icon">ğŸ”ï¸</span></span>
        <span class="cat-btn" onclick="selectEmoji(this,'ğŸ–ï¸')"><span class="cat-icon">ğŸ–ï¸</span></span>
        <span class="cat-btn" onclick="selectEmoji(this,'ğŸ™ï¸')"><span class="cat-icon">ğŸ™ï¸</span></span>
        <span class="cat-btn" onclick="selectEmoji(this,'ğŸš—')"><span class="cat-icon">ğŸš—</span></span>
        <span class="cat-btn" onclick="selectEmoji(this,'ğŸ›³ï¸')"><span class="cat-icon">ğŸ›³ï¸</span></span>
        <span class="cat-btn" onclick="selectEmoji(this,'ğŸ­')"><span class="cat-icon">ğŸ­</span></span>
        <span class="cat-btn" onclick="selectEmoji(this,'ğŸ¿')"><span class="cat-icon">ğŸ¿</span></span>
        <span class="cat-btn" onclick="selectEmoji(this,'ğŸŒ´')"><span class="cat-icon">ğŸŒ´</span></span>
      </div>
    </div>
    <div class="form-group">
      <label>Moneda</label>
      <select id="trip-currency">
        <option value="CLP">CLP â€” Peso Chileno</option>
        <option value="EUR">EUR â€” Euro</option>
        <option value="USD">USD â€” DÃ³lar</option>
        <option value="ARS">ARS â€” Peso Argentino</option>
      </select>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Fecha de inicio</label>
        <input type="date" id="trip-start-date">
      </div>
      <div class="form-group">
        <label>Fecha de regreso</label>
        <input type="date" id="trip-end-date">
      </div>
    </div>
    <div style="display:flex; gap:10px">
      <button class="btn btn-ghost" style="flex:1" onclick="closeModal('create-trip-modal')">Cancelar</button>
      <button class="btn btn-primary" style="flex:1" onclick="createTrip()">Crear viaje</button>
    </div>
  </div>
</div>

<!-- ADD EXPENSE MODAL -->
<div class="modal-overlay" id="add-expense-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2 class="modal-title" id="expense-modal-title">Agregar Gasto</h2>

    <div class="form-group">
      <label>Tipo</label>
      <div style="display:flex; gap:8px">
        <div class="cat-btn selected" id="type-shared" style="flex:1" onclick="selectExpenseType('shared')">
          <span class="cat-icon">ğŸ’¸</span>Compartido
        </div>
        <div class="cat-btn" id="type-personal" style="flex:1" onclick="selectExpenseType('personal')">
          <span class="cat-icon">ğŸ”’</span>Personal
        </div>
      </div>
    </div>

    <div class="form-group">
      <label>DescripciÃ³n</label>
      <input type="text" id="exp-desc" placeholder="Camper Dolomitas, Cena en Venecia...">
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Monto Total</label>
        <input type="number" id="exp-amount" placeholder="0" min="0">
      </div>
      <div class="form-group" id="paidby-group">
        <label>Pagado por</label>
        <select id="exp-paidby"></select>
      </div>
    </div>

    <div class="form-group">
      <label>CategorÃ­a</label>
      <div class="category-grid">
        <div class="cat-btn selected" onclick="selectCat(this,'Alojamiento','ğŸ ')"><span class="cat-icon">ğŸ </span><small>Alojam.</small></div>
        <div class="cat-btn" onclick="selectCat(this,'Vuelo','âœˆï¸')"><span class="cat-icon">âœˆï¸</span><small>Vuelo</small></div>
        <div class="cat-btn" onclick="selectCat(this,'Auto','ğŸš—')"><span class="cat-icon">ğŸš—</span><small>Auto</small></div>
        <div class="cat-btn" onclick="selectCat(this,'Tren','ğŸš‚')"><span class="cat-icon">ğŸš‚</span><small>Tren</small></div>
        <div class="cat-btn" onclick="selectCat(this,'Comida','ğŸ½ï¸')"><span class="cat-icon">ğŸ½ï¸</span><small>Comida</small></div>
        <div class="cat-btn" onclick="selectCat(this,'Actividades','ğŸ¯')"><span class="cat-icon">ğŸ¯</span><small>Activid.</small></div>
        <div class="cat-btn" onclick="selectCat(this,'Compras','ğŸ›ï¸')"><span class="cat-icon">ğŸ›ï¸</span><small>Compras</small></div>
        <div class="cat-btn" onclick="selectCat(this,'Entretenimiento','ğŸ‰')"><span class="cat-icon">ğŸ‰</span><small>Entret.</small></div>
        <div class="cat-btn" onclick="selectCat(this,'Salud','ğŸ’Š')"><span class="cat-icon">ğŸ’Š</span><small>Salud</small></div>
        <div class="cat-btn" onclick="selectCat(this,'Otro','ğŸ“¦')"><span class="cat-icon">ğŸ“¦</span><small>Otro</small></div>
      </div>
    </div>

    <div class="form-group" id="split-group">
      <label>Dividir entre</label>
      <div class="members-check" id="split-members"></div>
    </div>

    <div class="form-group">
      <label>Fecha</label>
      <input type="date" id="exp-date">
    </div>

    <div id="exp-preview" style="display:none; margin-bottom:16px; padding:14px; background:var(--surface2); border-radius:var(--radius-sm); font-size:0.88rem; color:var(--text2)"></div>
    <div style="display:flex; gap:10px">
      <button class="btn btn-ghost" style="flex:1" onclick="closeModal('add-expense-modal')">Cancelar</button>
      <button class="btn btn-primary" style="flex:1" onclick="saveExpense()">Guardar gasto</button>
    </div>
  </div>
</div>

<!-- INVITE MODAL -->
<div class="modal-overlay" id="invite-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2 class="modal-title">Invitar al viaje ğŸ‘¥</h2>
    <p class="text-muted" style="margin-bottom:16px">Comparte este cÃ³digo con tus compaÃ±eros de viaje para que se unan.</p>
    <div class="invite-box">
      <div>
        <div style="font-size:0.78rem; color:var(--text3); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:6px">CÃ³digo del viaje</div>
        <div class="invite-code" id="modal-invite-code">------</div>
      </div>
      <button class="btn btn-primary btn-sm" onclick="copyCode()">Copiar</button>
    </div>
    <p class="text-muted" style="margin-top:16px; font-size:0.82rem">
      Los miembros actuales:
    </p>
    <div id="modal-members-list" style="margin-top:8px"></div>
    <button class="btn btn-ghost" style="margin-top:20px; width:100%" onclick="closeModal('invite-modal')">Cerrar</button>
  </div>
</div>


<!-- BANK MODAL -->
<div class="modal-overlay" id="bank-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2 class="modal-title">ğŸ’³ Cuenta Bancaria</h2>
    <div class="form-group">
      <label>Banco</label>
      <select id="bank-name">
        <option value="">Selecciona banco</option>
        <option>Banco de Chile</option>
        <option>BancoEstado</option>
        <option>Santander</option>
        <option>BCI</option>
        <option>Scotiabank</option>
        <option>ItaÃº</option>
        <option>Falabella</option>
        <option>Ripley</option>
        <option>BICE</option>
        <option>Security</option>
        <option>Mercado Pago</option>
        <option>Tenpo</option>
        <option>Otro</option>
      </select>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Tipo de cuenta</label>
        <select id="bank-type">
          <option>Cuenta RUT</option>
          <option>Cuenta Corriente</option>
          <option>Cuenta Vista</option>
          <option>Cuenta de Ahorro</option>
        </select>
      </div>
      <div class="form-group">
        <label>NÃºmero de cuenta</label>
        <input type="text" id="bank-number" placeholder="12345678">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>RUT titular</label>
        <input type="text" id="bank-rut" placeholder="12.345.678-9">
      </div>
      <div class="form-group">
        <label>Nombre titular</label>
        <input type="text" id="bank-holder" placeholder="Pablo MuÃ±oz">
      </div>
    </div>
    <div style="display:flex; gap:10px; margin-top:8px">
      <button class="btn btn-ghost" style="flex:1" onclick="closeModal('bank-modal')">Cancelar</button>
      <button class="btn btn-primary" style="flex:1" onclick="saveBankAccount()">Guardar cuenta</button>
    </div>
  </div>
</div>


  <!-- BOTTOM NAV (mobile only) -->
  <nav class="bottom-nav" id="bottom-nav" style="display:none">
    <div class="bottom-nav-inner">
      <button class="bnav-btn active" id="bnav-shared" onclick="switchTabMobile('shared')">
        <span class="bnav-icon">ğŸ’¸</span>Compartido
      </button>
      <button class="bnav-btn" id="bnav-personal" onclick="switchTabMobile('personal')">
        <span class="bnav-icon">ğŸ”’</span>Personal
      </button>
      <button class="bnav-btn" id="bnav-balance" onclick="switchTabMobile('balance')">
        <span class="bnav-icon">âš–ï¸</span>Balance
      </button>
      <button class="bnav-btn" id="bnav-notes" onclick="switchTabMobile('notes')">
        <span class="bnav-icon">ğŸ“</span>Notas
      </button>
    </div>
  </nav>


<!-- CUSTOM CONFIRM DIALOG -->
<div class="confirm-overlay" id="confirm-overlay">
  <div class="confirm-box">
    <div class="confirm-icon" id="confirm-icon">âš ï¸</div>
    <div class="confirm-title" id="confirm-title">Â¿EstÃ¡s seguro?</div>
    <div class="confirm-msg" id="confirm-msg"></div>
    <div class="confirm-actions">
      <button class="btn btn-ghost" onclick="confirmResolve(false)">Cancelar</button>
      <button class="btn btn-danger" id="confirm-ok-btn" onclick="confirmResolve(true)">Eliminar</button>
    </div>
  </div>
</div>


<!-- LIGHTBOX -->
<div class="lightbox-overlay" id="lightbox" onclick="closeLightbox()">
  <div class="lightbox-close">âœ•</div>
  <img id="lightbox-img" src="" alt="Comprobante">
</div>


<!-- PAY INFO MODAL -->
<div class="modal-overlay" id="pay-info-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2 class="modal-title" id="pay-modal-title">ğŸ’³ Datos para transferir</h2>
    <div id="pay-modal-content">
      <p style="color:var(--text2)">Cargando...</p>
    </div>
    <button class="btn btn-ghost" style="width:100%; margin-top:20px" onclick="closeModal('pay-info-modal')">Cerrar</button>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- FIREBASE SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, query, where, onSnapshot, serverTimestamp, arrayUnion, arrayRemove }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // âš ï¸  REEMPLAZA ESTA CONFIGURACIÃ“N CON LA TUYA
  //     Ve a console.firebase.google.com â†’ Tu proyecto â†’ ConfiguraciÃ³n web
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const firebaseConfig = {
    apiKey: "AIzaSyDul4Wf-OzhugXQVrDbSF-kR9YEfqf4kXw",
    authDomain: "viajes-677d5.firebaseapp.com",
    projectId: "viajes-677d5",
    storageBucket: "viajes-677d5.firebasestorage.app",
    messagingSenderId: "195586680424",
    appId: "1:195586680424:web:3d639b746b292faa6e7ddd",
    measurementId: "G-6T1LQ80W25"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // â”€â”€â”€ State â”€â”€â”€
  let currentUser = null;
  let currentTrip = null;
  let currentTripId = null;
  let selectedEmoji = 'ğŸ”ï¸';
  let selectedCat = 'Alojamiento';
  let selectedCatIcon = 'ğŸ ';
  let selectedExpType = 'shared';
  let tripMembers = [];
  let selectedSplitMembers = [];
  let unsubscribeExpenses = null;
  let unsubscribeNotes = null;
  let editingExpenseId = null;

  // Expose to global
  window.doLogin = doLogin;
  window.doRegister = doRegister;
  window.doLogout = doLogout;
  window.switchAuthTab = switchAuthTab;
  window.openModal = openModal;
  window.closeModal = closeModal;
  window.createTrip = createTrip;
  window.joinByCode = joinByCode;
  window.goHome = goHome;
  window.switchTab = switchTab;
  window.openTripView = openTripView;
  window.selectEmoji = selectEmoji;
  window.selectCat = selectCat;
  window.selectExpenseType = selectExpenseType;
  window.saveExpense = saveExpense;
  window.claimPayment = claimPayment;
  window.confirmPayment = confirmPayment;
  window.addNote = addNote;
  window.copyCode = copyCode;
  window.openAddExpense = openAddExpense;
  window.deleteTrip = deleteTrip;
  window.leaveTrip = leaveTrip;
  window.toggleTripMenu = toggleTripMenu;
  window.editExpense = editExpense;
  window.deleteExpense = deleteExpense;
  window.openProfile = openProfile;
  window.saveBankAccount = saveBankAccount;
  window.openPayModal = openPayModal;
  window.switchTabMobile = switchTabMobile;

  // â”€â”€â”€ AUTH â”€â”€â”€
  onAuthStateChanged(auth, user => {
    if (user) {
      currentUser = user;
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      document.getElementById('nav-avatar').textContent = user.displayName ? user.displayName[0].toUpperCase() : '?';
      document.getElementById('nav-name').textContent = user.displayName || user.email;
      loadTrips();

      // Check if there's a pending join code
      const pendingCode = localStorage.getItem('pendingJoinCode');
      if (pendingCode) {
        localStorage.removeItem('pendingJoinCode');
        joinByCodeValue(pendingCode);
      }
    } else {
      currentUser = null;
      document.getElementById('auth-screen').style.display = 'flex';
      document.getElementById('app').style.display = 'none';
    }
  });

  async function doLogin() {
    const email = document.getElementById('login-email').value.trim();
    const pass = document.getElementById('login-password').value;
    try {
      await signInWithEmailAndPassword(auth, email, pass);
    } catch(e) {
      toast('Error: ' + friendlyError(e.code));
    }
  }

  async function doRegister() {
    const name = document.getElementById('reg-name').value.trim();
    const email = document.getElementById('reg-email').value.trim();
    const pass = document.getElementById('reg-password').value;
    if (!name) return toast('Ingresa tu nombre');
    try {
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      await updateProfile(cred.user, { displayName: name });
      currentUser = { ...cred.user, displayName: name };
    } catch(e) {
      toast('Error: ' + friendlyError(e.code));
    }
  }

  async function doLogout() {
    await signOut(auth);
  }

  function switchAuthTab(tab) {
    document.querySelectorAll('.auth-tab').forEach((t,i) => t.classList.toggle('active', (i===0 && tab==='login') || (i===1 && tab==='register')));
    document.getElementById('login-form').style.display = tab === 'login' ? 'block' : 'none';
    document.getElementById('register-form').style.display = tab === 'register' ? 'block' : 'none';
  }

  // â”€â”€â”€ TRIPS â”€â”€â”€
  async function loadTrips() {
    const tripsRef = collection(db, 'trips');
    const q = query(tripsRef, where('memberIds', 'array-contains', currentUser.uid));
    const snap = await getDocs(q);
    const trips = [];
    snap.forEach(d => trips.push({ id: d.id, ...d.data() }));
    renderTrips(trips);
  }

  function renderTrips(trips) {
    const container = document.getElementById('trips-list');
    if (!trips.length) {
      container.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ—ºï¸</div><p>No tienes viajes aÃºn</p><small>Crea uno o Ãºnete con un cÃ³digo</small></div>`;
      return;
    }
    container.innerHTML = trips.map(t => `
      <div class="trip-card" onclick="openTripView('${t.id}')">
        <div class="trip-card-header">
          <div class="trip-emoji">${t.emoji || 'âœˆï¸'}</div>
          <div class="trip-info">
            <div class="trip-name">${t.name}</div>
            <div class="trip-meta">
              <span>ğŸ‘¥ ${t.memberIds?.length || 1} personas</span>
              <span>${t.currency || 'CLP'}</span>
              ${t.description ? `<span>${t.description}</span>` : ''}
              ${t.startDate ? `<span>ğŸ“… ${formatDate(t.startDate)} â†’ ${t.endDate ? formatDate(t.endDate) : '?'}</span>` : ''}
            </div>
          </div>
          <span class="badge badge-blue">â†’</span>
        </div>
      </div>
    `).join('');
  }

  async function createTrip() {
    const name = document.getElementById('trip-name-input').value.trim();
    const desc = document.getElementById('trip-desc-input').value.trim();
    const currency = document.getElementById('trip-currency').value;
    if (!name) return toast('Ponle nombre al viaje âœˆï¸');

    const code = Math.random().toString(36).substr(2, 6).toUpperCase();
    const startDate = document.getElementById('trip-start-date').value;
    const endDate = document.getElementById('trip-end-date').value;
    const tripData = {
      name,
      description: desc,
      emoji: selectedEmoji,
      currency,
      code,
      startDate,
      endDate,
      createdBy: currentUser.uid,
      memberIds: [currentUser.uid],
      members: [{ uid: currentUser.uid, name: currentUser.displayName || currentUser.email }],
      createdAt: serverTimestamp()
    };
    const ref = await addDoc(collection(db, 'trips'), tripData);
    closeModal('create-trip-modal');
    toast('Viaje creado! ğŸ‰');
    loadTrips();
    setTimeout(() => openTripView(ref.id), 400);
  }

  async function joinByCode() {
    const code = document.getElementById('join-code').value.trim().toUpperCase();
    if (!code) return;
    if (!currentUser) {
      localStorage.setItem('pendingJoinCode', code);
      toast('Inicia sesiÃ³n para unirte');
      return;
    }
    await joinByCodeValue(code);
  }

  async function joinByCodeValue(code) {
    const q = query(collection(db, 'trips'), where('code', '==', code));
    const snap = await getDocs(q);
    if (snap.empty) return toast('CÃ³digo no encontrado');
    const tripDoc = snap.docs[0];
    const trip = tripDoc.data();
    if (trip.memberIds.includes(currentUser.uid)) return toast('Ya eres miembro de este viaje');
    await updateDoc(doc(db, 'trips', tripDoc.id), {
      memberIds: arrayUnion(currentUser.uid),
      members: arrayUnion({ uid: currentUser.uid, name: currentUser.displayName || currentUser.email })
    });
    toast('Â¡Te uniste al viaje! ğŸ‰');
    loadTrips();
    setTimeout(() => openTripView(tripDoc.id), 400);
  }

  // â”€â”€â”€ TRIP VIEW â”€â”€â”€
  async function openTripView(tripId) {
    const docSnap = await getDoc(doc(db, 'trips', tripId));
    if (!docSnap.exists()) return;
    currentTripId = tripId;
    currentTrip = { id: tripId, ...docSnap.data() };
    tripMembers = currentTrip.members || [];

    document.getElementById('home-view').style.display = 'none';
    document.getElementById('trip-view').style.display = 'block';
    document.getElementById('tv-emoji').textContent = currentTrip.emoji || 'âœˆï¸';
    document.getElementById('tv-name').textContent = currentTrip.name;
    document.getElementById('tv-desc').textContent = currentTrip.description || '';
    const datesRow = document.getElementById('tv-dates');
    if (currentTrip.startDate) {
      datesRow.innerHTML = `<span>ğŸ“…</span><span class="date-badge">${formatDate(currentTrip.startDate)}</span><span>â†’</span><span class="date-badge">${currentTrip.endDate ? formatDate(currentTrip.endDate) : '?'}</span>`;
      datesRow.style.display = 'flex';
    } else { datesRow.style.display = 'none'; }

    const membersRow = document.getElementById('tv-members');
    membersRow.innerHTML = tripMembers.map(m => `
      <div class="member-chip">
        <div class="avatar" style="width:28px; height:28px; font-size:0.75rem">${(m.name||'?')[0].toUpperCase()}</div>
        ${m.name}
      </div>
    `).join('');

    switchTab('shared');
    subscribeExpenses();
    subscribeNotes();
    document.getElementById('bottom-nav').style.display = 'block';
    // Set danger button label depending on whether user is creator
    const dangerBtn = document.getElementById('trip-action-btn');
    if (currentTrip.createdBy === currentUser.uid) {
      dangerBtn.textContent = 'ğŸ—‘ï¸ Eliminar viaje';
    } else {
      dangerBtn.textContent = 'ğŸšª Salir del viaje';
    }
  }

  function goHome() {
    document.getElementById('home-view').style.display = 'block';
    document.getElementById('trip-view').style.display = 'none';
    document.getElementById('bottom-nav').style.display = 'none';
    if (unsubscribeExpenses) { unsubscribeExpenses(); unsubscribeExpenses = null; }
    if (unsubscribeNotes) { unsubscribeNotes(); unsubscribeNotes = null; }
    currentTripId = null;
    currentTrip = null;
    loadTrips();
  }

  function switchTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.section-panel').forEach(p => p.classList.remove('active'));
    const tabIndex = ['shared','personal','balance','notes'].indexOf(tab);
    document.querySelectorAll('.tab')[tabIndex].classList.add('active');
    document.getElementById('panel-' + tab).classList.add('active');
    if (tab === 'balance') renderBalance();
    document.getElementById('fab-btn').style.display = (tab === 'balance') ? 'none' : 'flex';
  }


  function switchTabMobile(tab) {
    switchTab(tab);
    // Update bottom nav active state
    ['shared','personal','balance','notes'].forEach(t => {
      const btn = document.getElementById('bnav-' + t);
      if (btn) btn.classList.toggle('active', t === tab);
    });
  }
  window.switchTabMobile = switchTabMobile;

  // â”€â”€â”€ EXPENSES â”€â”€â”€
  function subscribeExpenses() {
    if (unsubscribeExpenses) unsubscribeExpenses();
    const q = query(collection(db, 'trips', currentTripId, 'expenses'));
    unsubscribeExpenses = onSnapshot(q, snap => {
      const expenses = [];
      snap.forEach(d => expenses.push({ id: d.id, ...d.data() }));
      renderSharedExpenses(expenses.filter(e => e.type === 'shared'));
      renderPersonalExpenses(expenses.filter(e => e.type === 'personal' && e.createdBy === currentUser.uid));
    });
  }

  function renderSharedExpenses(expenses) {
    const container = document.getElementById('shared-list');
    if (!expenses.length) {
      container.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ’¸</div><p>Sin gastos compartidos aÃºn</p><small>Toca + para agregar el primero</small></div>`;
      return;
    }
    expenses.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
    container.innerHTML = expenses.map(e => renderExpenseCard(e, true)).join('');
  }

  function renderPersonalExpenses(expenses) {
    const container = document.getElementById('personal-list');
    if (!expenses.length) {
      container.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ”’</div><p>Sin gastos personales</p><small>Solo tÃº puedes verlos</small></div>`;
      return;
    }
    expenses.sort((a,b) => {
      const da = a.date || ''; const db2 = b.date || '';
      if (da && db2) return db2.localeCompare(da);
      return (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0);
    });
    const total = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
    const currency = currentTrip?.currency || 'CLP';
    const totalBar = `<div class="total-bar">
      <div>
        <div class="total-bar-label">Total mis gastos personales</div>
        <div style="font-size:0.78rem; color:var(--text3); margin-top:2px">${expenses.length} gasto${expenses.length !== 1 ? 's' : ''}</div>
      </div>
      <div class="total-bar-amount">${formatAmount(total, currency)}</div>
    </div>`;
    container.innerHTML = totalBar + expenses.map(e => renderExpenseCard(e, false)).join('');
  }

  function renderExpenseCard(e, showPayments) {
    const splitWith = e.splitWith || tripMembers.map(m => m.uid);
    const perPerson = splitWith.length > 0 ? Math.round(e.amount / splitWith.length) : e.amount;
    const currency = currentTrip?.currency || 'CLP';
    const catColors = { Alojamiento:'#5b8cf7', Vuelo:'#e8c97a', Auto:'#f0a050', Tren:'#a0c4ff', Comida:'#7cefb0', Actividades:'#f07878', Compras:'#b07cef', Entretenimiento:'#ef9b7c', Salud:'#7cd4ef', Otro:'#8a8fa3' };
    const color = catColors[e.category] || '#5b8cf7';

    let paymentsHtml = '';
    if (showPayments && splitWith.length > 0) {
      const isCreator = e.createdBy === currentUser.uid;
      const pills = splitWith.map(uid => {
        const member = tripMembers.find(m => m.uid === uid);
        const name = member ? member.name : uid;
        const firstName = name.split(' ')[0];
        const isPayer = uid === e.paidBy;
        const payState = isPayer ? 'confirmed' : (e.payments?.[uid] || 'unpaid');

        let pillClass, pillIcon, pillTitle, clickAttr = '';

        if (payState === 'confirmed') {
          pillClass = 'confirmed';
          pillIcon = 'âœ“';
          pillTitle = isPayer ? 'Pagador original' : 'Confirmado por el creador';
        } else if (payState === 'claimed') {
          if (isCreator && uid !== currentUser.uid) {
            pillClass = 'claimed can-confirm';
            pillIcon = 'ğŸ•';
            pillTitle = 'Clic para confirmar que recibiste el pago';
            clickAttr = 'onclick="confirmPayment(\'' + e.id + '\',\'' + uid + '\')"';
          } else {
            pillClass = 'claimed';
            pillIcon = 'ğŸ•';
            pillTitle = 'Pagado â€” esperando confirmaciÃ³n del creador';
          }
        } else {
          pillClass = 'unpaid';
          pillIcon = 'â—‹';
          if (uid === currentUser.uid && !isPayer) {
            pillTitle = 'Clic para marcar que ya pagaste';
            clickAttr = 'onclick="claimPayment(\'' + e.id + '\',\'' + uid + '\')"';
          } else {
            pillTitle = 'Pendiente de pago';
          }
        }

        return '<div class="payment-pill ' + pillClass + '" ' + clickAttr + ' title="' + pillTitle + '">'
          + '<span class="pill-icon">' + pillIcon + '</span> '
          + firstName + (isPayer ? ' ğŸ’³' : '')
          + '</div>';
      }).join('');
      paymentsHtml = `<div class="payments-section">
        <div class="payments-label">Confirmaciones de pago</div>
        <div class="payment-pills">${pills}</div>
      </div>`;
    }

    const paidByMember = tripMembers.find(m => m.uid === e.paidBy);
    const paidByName = paidByMember ? paidByMember.name.split(' ')[0] : 'Alguien';

    const canEdit = e.createdBy === currentUser.uid;
    const dotsMenu = canEdit ? `
      <div style="display:flex; flex-direction:column; gap:4px; margin-left:6px">
        <button class="dots-btn" onclick="editExpense('${e.id}')" title="Editar" style="font-size:0.9rem">âœï¸</button>
        <button class="dots-btn" onclick="deleteExpense('${e.id}')" title="Eliminar" style="font-size:0.9rem; color:var(--danger)">ğŸ—‘ï¸</button>
      </div>` : '';

    return `<div class="expense-card">
      <div class="expense-header">
        <div class="expense-icon" style="background:${color}22; color:${color}">${e.categoryIcon || 'ğŸ“¦'}</div>
        <div class="expense-details">
          <div class="expense-title">${e.description}</div>
          <div class="expense-meta">
            <span>ğŸ’³ ${paidByName} <span style="cursor:pointer; color:var(--accent2); font-size:0.78rem" onclick="openPayModal('${e.paidBy}', event)">ver datos â†’</span></span>
            <span>${e.category || 'Otro'}</span>
            <span>${e.date || ''}</span>
            ${showPayments ? `<span>ğŸ‘¥ ${splitWith.length} personas</span>` : ''}
          </div>
        </div>
        <div style="display:flex; align-items:flex-start; gap:4px">
          <div class="expense-amount">
            <div class="total">${formatAmount(e.amount, currency)}</div>
            ${showPayments && splitWith.length > 1 ? `<div class="per-person">${formatAmount(perPerson, currency)} c/u</div>` : ''}
          </div>
          ${dotsMenu}
        </div>
      </div>
      ${paymentsHtml}
    </div>`;
  }

  // Quien pagÃ³ reclama su pago â†’ estado 'claimed' (amarillo)
  async function claimPayment(expenseId, uid) {
    const expRef = doc(db, 'trips', currentTripId, 'expenses', expenseId);
    const expSnap = await getDoc(expRef);
    if (!expSnap.exists()) return;
    const payments = { ...(expSnap.data().payments || {}) };
    if (payments[uid] === 'claimed') {
      // Permite desmarcar si aÃºn no estÃ¡ confirmado
      delete payments[uid];
      await updateDoc(expRef, { payments });
      toast('Pago desmarcado');
    } else {
      payments[uid] = 'claimed';
      await updateDoc(expRef, { payments });
      toast('ğŸ• Marcado como pagado â€” esperando confirmaciÃ³n');
    }
  }

  // El creador del gasto confirma que recibiÃ³ el dinero â†’ estado 'confirmed' (verde)
  async function confirmPayment(expenseId, uid) {
    const expRef = doc(db, 'trips', currentTripId, 'expenses', expenseId);
    const expSnap = await getDoc(expRef);
    if (!expSnap.exists()) return;
    const payments = { ...(expSnap.data().payments || {}) };
    const member = tripMembers.find(m => m.uid === uid);
    const name = member ? member.name.split(' ')[0] : 'esta persona';
    payments[uid] = 'confirmed';
    await updateDoc(expRef, { payments });
    toast('âœ… Confirmado â€” ' + name + ' pagÃ³ su parte');;
  }

  // â”€â”€â”€ ADD EXPENSE â”€â”€â”€
  function openAddExpense() {
    if (!currentTripId) return;
    // Reset form
    document.getElementById('exp-desc').value = '';
    document.getElementById('exp-amount').value = '';
    document.getElementById('exp-date').value = new Date().toISOString().split('T')[0];
    selectedExpType = 'shared';
    selectedCat = 'Alojamiento';
    selectedCatIcon = 'ğŸ ';

    // Populate paidby
    const paidBySelect = document.getElementById('exp-paidby');
    paidBySelect.innerHTML = tripMembers.map(m => `<option value="${m.uid}" ${m.uid === currentUser.uid ? 'selected' : ''}>${m.name}</option>`).join('');

    // Split members
    selectedSplitMembers = tripMembers.map(m => m.uid);
    renderSplitMembers();

    // Reset UI
    document.querySelectorAll('#add-expense-modal .cat-btn').forEach((b,i) => b.classList.toggle('selected', i===0));
    document.getElementById('type-shared').classList.add('selected');
    document.getElementById('type-personal').classList.remove('selected');
    document.getElementById('split-group').style.display = 'block';
    document.getElementById('paidby-group').style.display = 'block';
    editingExpenseId = null;
    document.getElementById('expense-modal-title').textContent = 'Agregar Gasto';

    // Preview updater
    document.getElementById('exp-amount').oninput = updateExpensePreview;

    openModal('add-expense-modal');
  }

  function renderSplitMembers() {
    const container = document.getElementById('split-members');
    container.innerHTML = tripMembers.map(m => {
      const checked = selectedSplitMembers.includes(m.uid);
      return `<div class="member-check-item ${checked ? 'checked' : ''}" onclick="toggleSplitMember('${m.uid}', this)">
        <div class="check-circle">${checked ? 'âœ“' : ''}</div>
        <div class="avatar" style="width:28px;height:28px;font-size:0.75rem">${(m.name||'?')[0].toUpperCase()}</div>
        ${m.name}
      </div>`;
    }).join('');
  }

  window.toggleSplitMember = function(uid, el) {
    const idx = selectedSplitMembers.indexOf(uid);
    if (idx > -1) {
      if (selectedSplitMembers.length <= 1) return toast('Debe haber al menos una persona');
      selectedSplitMembers.splice(idx, 1);
      el.classList.remove('checked');
      el.querySelector('.check-circle').textContent = '';
    } else {
      selectedSplitMembers.push(uid);
      el.classList.add('checked');
      el.querySelector('.check-circle').textContent = 'âœ“';
    }
    updateExpensePreview();
  };

  function updateExpensePreview() {
    const amount = parseFloat(document.getElementById('exp-amount').value) || 0;
    const preview = document.getElementById('exp-preview');
    if (amount > 0 && selectedExpType === 'shared' && selectedSplitMembers.length > 0) {
      const perPerson = Math.round(amount / selectedSplitMembers.length);
      const currency = currentTrip?.currency || 'CLP';
      preview.style.display = 'block';
      preview.innerHTML = `ğŸ’¡ <strong>${formatAmount(amount, currency)}</strong> total Ã· ${selectedSplitMembers.length} personas = <strong style="color:var(--accent)">${formatAmount(perPerson, currency)} por persona</strong>`;
    } else {
      preview.style.display = 'none';
    }
  }

  function selectExpenseType(type) {
    selectedExpType = type;
    document.getElementById('type-shared').classList.toggle('selected', type === 'shared');
    document.getElementById('type-personal').classList.toggle('selected', type === 'personal');
    document.getElementById('split-group').style.display = type === 'shared' ? 'block' : 'none';
    document.getElementById('paidby-group').style.display = type === 'shared' ? 'block' : 'none';
    updateExpensePreview();
  }

  async function saveExpense() {
    const desc = document.getElementById('exp-desc').value.trim();
    const amount = parseFloat(document.getElementById('exp-amount').value);
    const date = document.getElementById('exp-date').value;
    if (!desc) return toast('Agrega una descripciÃ³n');
    if (!amount || amount <= 0) return toast('El monto debe ser mayor a 0');

    const paidBy = selectedExpType === 'shared' ? document.getElementById('exp-paidby').value : currentUser.uid;
    const expData = {
      description: desc,
      amount,
      category: selectedCat,
      categoryIcon: selectedCatIcon,
      date,
      type: selectedExpType,
      paidBy,
      splitWith: selectedExpType === 'shared' ? selectedSplitMembers : [currentUser.uid],
    };

    if (editingExpenseId) {
      await updateDoc(doc(db, 'trips', currentTripId, 'expenses', editingExpenseId), expData);
      toast('Gasto actualizado âœ“');
      editingExpenseId = null;
    } else {
      await addDoc(collection(db, 'trips', currentTripId, 'expenses'), {
        ...expData,
        payments: {},
        createdBy: currentUser.uid,
        createdAt: serverTimestamp()
      });
      toast('Gasto guardado âœ“');
    }
    closeModal('add-expense-modal');
    if (selectedExpType !== 'personal') switchTab('shared');
    else switchTab('personal');
  }


  // â”€â”€â”€ TRIP MENU â”€â”€â”€
  function positionMenu(menu, btn, menuHeight) {
    const rect = btn.getBoundingClientRect();
    const menuWidth = 180;
    let left = rect.right - menuWidth;
    let top = rect.bottom + 4;
    if (left < 8) left = 8;
    if (left + menuWidth > window.innerWidth - 8) left = window.innerWidth - menuWidth - 8;
    if (top + menuHeight > window.innerHeight - 8) top = rect.top - menuHeight - 4;
    menu.style.left = left + 'px';
    menu.style.top = top + 'px';
  }

  function toggleTripMenu(tripId, btn) {
    document.querySelectorAll('.dropdown-menu').forEach(m => {
      if (m.id !== 'trip-menu-' + tripId) m.classList.remove('open');
    });
    const menu = document.getElementById('trip-menu-' + tripId);
    if (!menu) return;
    if (menu.classList.contains('open')) { menu.classList.remove('open'); return; }
    menu.classList.add('open');
    positionMenu(menu, btn, menu.offsetHeight || 90);
  }

  window.toggleExpenseMenu = function(expId, btn) {
    document.querySelectorAll('.dropdown-menu').forEach(m => {
      if (m.id !== 'exp-menu-' + expId) m.classList.remove('open');
    });
    const menu = document.getElementById('exp-menu-' + expId);
    if (!menu) return;
    if (menu.classList.contains('open')) { menu.classList.remove('open'); return; }
    menu.classList.add('open');
    positionMenu(menu, btn, menu.offsetHeight || 90);
  };

  async function tripDangerAction() {
    if (!currentTripId || !currentTrip) return;
    if (currentTrip.createdBy === currentUser.uid) {
      await deleteTrip(currentTripId, currentTrip.name);
    } else {
      await leaveTrip(currentTripId, currentTrip.name);
    }
  }
  window.tripDangerAction = tripDangerAction;

  async function deleteTrip(tripId, name) {
    const ok = await customConfirm({
      icon: 'ğŸ—‘ï¸',
      title: 'Â¿Eliminar viaje?',
      msg: '"' + name + '" y todos sus gastos se borrarÃ¡n para siempre. No se puede deshacer.',
      okLabel: 'SÃ­, eliminar',
      okClass: 'btn-danger'
    });
    if (!ok) return;
    // Delete all expenses subcollection
    const expSnap = await getDocs(collection(db, 'trips', tripId, 'expenses'));
    for (const d of expSnap.docs) await deleteDoc(doc(db, 'trips', tripId, 'expenses', d.id));
    const notesSnap = await getDocs(collection(db, 'trips', tripId, 'notes'));
    for (const d of notesSnap.docs) await deleteDoc(doc(db, 'trips', tripId, 'notes', d.id));
    await deleteDoc(doc(db, 'trips', tripId));
    toast('Viaje eliminado ğŸ—‘ï¸');
    goHome();
  }

  async function leaveTrip(tripId, name) {
    const ok = await customConfirm({
      icon: 'ğŸšª',
      title: 'Â¿Salir del viaje?',
      msg: 'DejarÃ¡s el viaje "' + name + '". Puedes volver a unirte con el cÃ³digo.',
      okLabel: 'Salir',
      okClass: 'btn-danger'
    });
    if (!ok) return;
    await updateDoc(doc(db, 'trips', tripId), {
      memberIds: arrayRemove(currentUser.uid),
      members: arrayRemove(tripMembers.find(m => m.uid === currentUser.uid))
    });
    toast('Saliste del viaje');
    goHome();
  }

  // â”€â”€â”€ EDIT EXPENSE â”€â”€â”€
  async function editExpense(expId) {
    document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('open'));
    const expSnap = await getDoc(doc(db, 'trips', currentTripId, 'expenses', expId));
    if (!expSnap.exists()) return;
    const e = { id: expId, ...expSnap.data() };

    editingExpenseId = expId;
    selectedExpType = e.type;
    selectedCat = e.category || 'Alojamiento';
    selectedCatIcon = e.categoryIcon || 'ğŸ ';
    selectedSplitMembers = e.splitWith || tripMembers.map(m => m.uid);

    document.getElementById('expense-modal-title').textContent = 'âœï¸ Editar Gasto';
    document.getElementById('exp-desc').value = e.description;
    document.getElementById('exp-amount').value = e.amount;
    document.getElementById('exp-date').value = e.date || '';

    const paidBySelect = document.getElementById('exp-paidby');
    paidBySelect.innerHTML = tripMembers.map(m => `<option value="${m.uid}" ${m.uid === e.paidBy ? 'selected' : ''}>${m.name}</option>`).join('');

    // Set type UI
    document.getElementById('type-shared').classList.toggle('selected', e.type === 'shared');
    document.getElementById('type-personal').classList.toggle('selected', e.type === 'personal');
    document.getElementById('split-group').style.display = e.type === 'shared' ? 'block' : 'none';
    document.getElementById('paidby-group').style.display = e.type === 'shared' ? 'block' : 'none';

    // Set category UI
    document.querySelectorAll('.category-grid .cat-btn').forEach(btn => {
      const catName = btn.getAttribute('onclick')?.match(/'([^']+)'/)?.[1];
      btn.classList.toggle('selected', catName === e.category);
    });

    renderSplitMembers();
    document.getElementById('exp-amount').oninput = updateExpensePreview;
    updateExpensePreview();
    openModal('add-expense-modal');
  }

  async function deleteExpense(expId) {
    document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('open'));
    const ok = await customConfirm({
      icon: 'ğŸ’¸',
      title: 'Â¿Eliminar gasto?',
      msg: 'Este gasto se borrarÃ¡ y no se podrÃ¡ recuperar.',
      okLabel: 'Eliminar',
      okClass: 'btn-danger'
    });
    if (!ok) return;
    await deleteDoc(doc(db, 'trips', currentTripId, 'expenses', expId));
    toast('Gasto eliminado');
  }



  // â”€â”€â”€ CUSTOM CONFIRM â”€â”€â”€
  let _confirmResolve = null;

  function customConfirm({ icon = 'âš ï¸', title = 'Â¿EstÃ¡s seguro?', msg = '', okLabel = 'Confirmar', okClass = 'btn-danger' } = {}) {
    return new Promise(resolve => {
      _confirmResolve = resolve;
      document.getElementById('confirm-icon').textContent = icon;
      document.getElementById('confirm-title').textContent = title;
      document.getElementById('confirm-msg').textContent = msg;
      const okBtn = document.getElementById('confirm-ok-btn');
      okBtn.textContent = okLabel;
      okBtn.className = 'btn ' + okClass;
      document.getElementById('confirm-overlay').classList.add('show');
    });
  }

  window.confirmResolve = function(val) {
    document.getElementById('confirm-overlay').classList.remove('show');
    if (_confirmResolve) { _confirmResolve(val); _confirmResolve = null; }
  };


  function openLightbox(url) {
    document.getElementById('lightbox-img').src = url;
    document.getElementById('lightbox').classList.add('show');
  }
  window.closeLightbox = function() {
    document.getElementById('lightbox').classList.remove('show');
  };
  window.openLightbox = openLightbox;

  // â”€â”€â”€ PROFILE â”€â”€â”€
  function openProfile() {
    document.getElementById('home-view').style.display = 'none';
    document.getElementById('trip-view').style.display = 'none';
    document.getElementById('profile-view').style.display = 'block';
    document.getElementById('bottom-nav').style.display = 'none';
    const u = currentUser;
    document.getElementById('pv-avatar').textContent = (u.displayName || '?')[0].toUpperCase();
    document.getElementById('pv-name').textContent = u.displayName || 'Sin nombre';
    document.getElementById('pv-email').textContent = u.email;
    loadBankAccounts();
  }

  async function loadBankAccounts() {
    const snap = await getDocs(collection(db, 'users', currentUser.uid, 'bankAccounts'));
    const accounts = [];
    snap.forEach(d => accounts.push({ id: d.id, ...d.data() }));
    const container = document.getElementById('bank-cards-list');
    if (!accounts.length) {
      container.innerHTML = '<p style="color:var(--text3); font-size:0.88rem; margin-bottom:12px">Sin cuentas bancarias aÃºn</p>';
      return;
    }
    container.innerHTML = accounts.map(a => {
      const clipText = [
        'Nombre: ' + a.holder,
        'RUT: ' + a.rut,
        'Banco: ' + a.bank,
        'Tipo de cuenta: ' + a.type,
        'NÃºmero de cuenta: ' + a.number
      ].join('\n');
      return `
      <div class="bank-card">
        <div class="bank-card-header">
          <div class="bank-card-bank">ğŸ¦ ${a.bank}</div>
          <button class="btn btn-danger btn-sm" onclick="deleteBankAccount('${a.id}')">Eliminar</button>
        </div>
        <div class="bank-card-grid">
          <div class="bank-card-field"><div class="field-label">Titular</div><div class="field-value">${a.holder}</div></div>
          <div class="bank-card-field"><div class="field-label">RUT</div><div class="field-value">${a.rut}</div></div>
          <div class="bank-card-field"><div class="field-label">Tipo</div><div class="field-value">${a.type}</div></div>
          <div class="bank-card-field"><div class="field-label">NÂ° Cuenta</div><div class="field-value">${a.number}</div></div>
        </div>
        <button class="btn btn-ghost btn-sm" style="width:100%; margin-top:10px"
          data-clip="${clipText.replace(/"/g,'&quot;')}"
          onclick="copyBankData(this, this.dataset.clip)">
          ğŸ“‹ Copiar mis datos para compartir
        </button>
      </div>
    `}).join('');
  }

  async function saveBankAccount() {
    const bank = document.getElementById('bank-name').value;
    const type = document.getElementById('bank-type').value;
    const number = document.getElementById('bank-number').value.trim();
    const rut = document.getElementById('bank-rut').value.trim();
    const holder = document.getElementById('bank-holder').value.trim();
    if (!bank) return toast('Selecciona un banco');
    if (!number) return toast('Ingresa el nÃºmero de cuenta');
    await addDoc(collection(db, 'users', currentUser.uid, 'bankAccounts'), { bank, type, number, rut, holder });
    closeModal('bank-modal');
    toast('Cuenta guardada âœ“');
    loadBankAccounts();
  }

  async function deleteBankAccount(id) {
    const ok = await customConfirm({
      icon: 'ğŸ’³',
      title: 'Â¿Eliminar cuenta?',
      msg: 'Se borrarÃ¡ esta cuenta bancaria de tu perfil.',
      okLabel: 'Eliminar',
      okClass: 'btn-danger'
    });
    if (!ok) return;
    await deleteDoc(doc(db, 'users', currentUser.uid, 'bankAccounts', id));
    toast('Cuenta eliminada');
    loadBankAccounts();
  }

  // â”€â”€â”€ PAY INFO TOGGLE â”€â”€â”€
  async function togglePayInfo(expId, payerUid, event) {
    event.stopPropagation();
    const box = document.getElementById('payinfo-' + expId);
    if (box.classList.contains('show')) { box.classList.remove('show'); return; }
    const snap = await getDocs(collection(db, 'users', payerUid, 'bankAccounts'));
    const accounts = [];
    snap.forEach(d => accounts.push(d.data()));
    if (!accounts.length) {
      box.innerHTML = '<p style="color:var(--text2); font-size:0.85rem; padding:4px 0">Esta persona no tiene datos bancarios registrados</p>';
    } else {
      box.innerHTML = accounts.map((a, idx) => {
        // Build Chilean bank transfer format for clipboard
        const clipText = [
          'Nombre: ' + a.holder,
          'RUT: ' + a.rut,
          'Banco: ' + a.bank,
          'Tipo de cuenta: ' + a.type,
          'NÃºmero de cuenta: ' + a.number
        ].join('\n');

        return `
        <div style="margin-bottom:${accounts.length > 1 ? '12px' : '0'}">
          <div style="font-weight:700; margin-bottom:8px; color:var(--accent); font-size:0.9rem">
            ğŸ¦ ${a.bank}
          </div>
          <div class="pay-info-row"><span class="key">Titular</span><span class="val">${a.holder}</span></div>
          <div class="pay-info-row"><span class="key">RUT</span><span class="val">${a.rut}</span></div>
          <div class="pay-info-row"><span class="key">Tipo</span><span class="val">${a.type}</span></div>
          <div class="pay-info-row"><span class="key">NÂ° Cuenta</span><span class="val">${a.number}</span></div>
          <button class="btn btn-primary btn-sm" style="width:100%; margin-top:10px; gap:6px"
            data-clip="${clipText.replace(/"/g,'&quot;').replace(/`/g,'')}"
            onclick="copyBankData(this, this.dataset.clip)">
            ğŸ“‹ Copiar datos para transferir
          </button>
        </div>
        ${idx < accounts.length - 1 ? '<hr style="border:none;border-top:1px solid var(--border);margin:10px 0">' : ''}
        `;
      }).join('');
    }
    box.classList.add('show');
  }

  window.copyBankData = function(btn, text) {
    navigator.clipboard.writeText(text).then(() => {
      const original = btn.innerHTML;
      btn.innerHTML = 'âœ… Â¡Copiado! Pega en tu app del banco';
      btn.style.background = 'rgba(124,239,176,0.2)';
      btn.style.color = 'var(--accent3)';
      btn.style.border = '1px solid rgba(124,239,176,0.3)';
      setTimeout(() => {
        btn.innerHTML = original;
        btn.style.background = '';
        btn.style.color = '';
        btn.style.border = '';
      }, 2500);
    }).catch(() => {
      // Fallback for older browsers
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed';
      ta.style.opacity = '0';
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      btn.innerHTML = 'âœ… Â¡Copiado!';
      setTimeout(() => { btn.innerHTML = 'ğŸ“‹ Copiar datos para transferir'; }, 2000);
    });
  };

  // â”€â”€â”€ RECEIPT UPLOAD (ImgBB) â”€â”€â”€

  function formatDate(dateStr) {
    if (!dateStr) return '';
    const [y, m, d] = dateStr.split('-');
    const months = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
    return `${d} ${months[parseInt(m)-1]} ${y}`;
  }

  // â”€â”€â”€ BALANCE â”€â”€â”€
  async function renderBalance() {
    const q = query(collection(db, 'trips', currentTripId, 'expenses'));
    const snap = await getDocs(q);
    const expenses = [];
    snap.forEach(d => expenses.push({ id: d.id, ...d.data() }));

    const sharedExpenses = expenses.filter(e => e.type === 'shared');
    const currency = currentTrip?.currency || 'CLP';

    // Track total paid per person (for summary row)
    const paid = {};
    const owes = {};
    tripMembers.forEach(m => { paid[m.uid] = 0; owes[m.uid] = 0; });

    // Track direct debts: debts[from][to] = amount owed
    const debts = {};
    tripMembers.forEach(m => {
      debts[m.uid] = {};
      tripMembers.forEach(n => { debts[m.uid][n.uid] = 0; });
    });

    sharedExpenses.forEach(e => {
      const splitWith = e.splitWith || tripMembers.map(m => m.uid);
      const perPerson = e.amount / splitWith.length;
      if (paid[e.paidBy] !== undefined) paid[e.paidBy] += e.amount;
      splitWith.forEach(uid => {
        if (owes[uid] !== undefined) owes[uid] += perPerson;
        // Each member who didn't pay owes the payer their share
        if (uid !== e.paidBy && debts[uid] && debts[uid][e.paidBy] !== undefined) {
          debts[uid][e.paidBy] += perPerson;
        }
      });
    });

    // Simplify debts: if A owes B and B owes A, net them out
    tripMembers.forEach(a => {
      tripMembers.forEach(b => {
        if (a.uid >= b.uid) return; // only process each pair once
        const ab = debts[a.uid][b.uid] || 0;
        const ba = debts[b.uid][a.uid] || 0;
        if (ab > ba) {
          debts[a.uid][b.uid] = ab - ba;
          debts[b.uid][a.uid] = 0;
        } else {
          debts[b.uid][a.uid] = ba - ab;
          debts[a.uid][b.uid] = 0;
        }
      });
    });

    // Summary per person
    const net = {};
    tripMembers.forEach(m => { net[m.uid] = paid[m.uid] - owes[m.uid]; });

    const balanceList = document.getElementById('balance-list');
    balanceList.innerHTML = tripMembers.map(m => {
      const n = net[m.uid] || 0;
      const cls = n > 0 ? 'balance-positive' : n < 0 ? 'balance-negative' : 'balance-neutral';
      const label = n > 0 ? 'Le deben' : n < 0 ? 'Debe' : 'Al dÃ­a';
      return `<div class="balance-person">
        <div class="balance-left">
          <div class="avatar avatar-lg">${(m.name||'?')[0].toUpperCase()}</div>
          <div>
            <div style="font-weight:600">${m.name}</div>
            <div style="font-size:0.82rem; color:var(--text2)">PagÃ³ ${formatAmount(paid[m.uid]||0, currency)}</div>
          </div>
        </div>
        <div style="text-align:right">
          <div class="balance-amount ${cls}">${n > 0 ? '+' : ''}${formatAmount(n, currency)}</div>
          <div style="font-size:0.78rem; color:var(--text3)">${label}</div>
        </div>
      </div>`;
    }).join('');

    // Show direct debts between each pair
    const owedList = document.getElementById('owed-list');
    const transactions = [];
    tripMembers.forEach(from => {
      tripMembers.forEach(to => {
        const amt = debts[from.uid]?.[to.uid] || 0;
        if (amt > 1) transactions.push({ from: from.name, to: to.name, fromUid: from.uid, toUid: to.uid, amount: amt });
      });
    });

    if (!transactions.length) {
      owedList.innerHTML = '<p style="color:var(--text2); font-size:0.9rem">ğŸ‰ Â¡Todos estÃ¡n al dÃ­a!</p>';
      return;
    }

    owedList.innerHTML = transactions.map(t => `
      <div style="display:flex; align-items:center; gap:8px; padding:12px 0; border-bottom:1px solid var(--border)">
        <div class="avatar" style="width:32px;height:32px;font-size:0.8rem">${t.from[0]}</div>
        <div style="flex:1">
          <strong>${t.from.split(' ')[0]}</strong>
          <span style="color:var(--text2)"> le debe a </span>
          <strong>${t.to.split(' ')[0]}</strong>
        </div>
        <div style="font-family:'Fraunces',serif; color:var(--danger); font-size:1.1rem; font-weight:600">${formatAmount(t.amount, currency)}</div>
      </div>
    `).join('');
  }

  // â”€â”€â”€ NOTES â”€â”€â”€
  function subscribeNotes() {
    if (unsubscribeNotes) unsubscribeNotes();
    const q = query(collection(db, 'trips', currentTripId, 'notes'));
    unsubscribeNotes = onSnapshot(q, snap => {
      const notes = [];
      snap.forEach(d => notes.push({ id: d.id, ...d.data() }));
      notes.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
      const container = document.getElementById('notes-list');
      if (!notes.length) {
        container.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“</div><p>Sin notas aÃºn</p></div>`;
        return;
      }
      container.innerHTML = notes.map(n => `
        <div class="note-card">
          <div class="note-author">
            <div class="avatar" style="width:28px;height:28px;font-size:0.75rem">${(n.authorName||'?')[0].toUpperCase()}</div>
            <strong style="font-size:0.9rem">${n.authorName}</strong>
            <span class="text-muted">${n.date || ''}</span>
          </div>
          <p style="font-size:0.95rem; line-height:1.6; color:var(--text)">${n.content}</p>
        </div>
      `).join('');
    });
  }

  async function addNote() {
    const content = document.getElementById('note-input').value.trim();
    if (!content) return;
    await addDoc(collection(db, 'trips', currentTripId, 'notes'), {
      content,
      authorId: currentUser.uid,
      authorName: currentUser.displayName || currentUser.email,
      date: new Date().toLocaleDateString('es-CL'),
      createdAt: serverTimestamp()
    });
    document.getElementById('note-input').value = '';
    toast('Nota publicada âœ“');
  }

  // â”€â”€â”€ INVITE â”€â”€â”€
  window.openModal = function(id) {
    if (id === 'invite-modal' && currentTrip) {
      document.getElementById('modal-invite-code').textContent = currentTrip.code;
      document.getElementById('modal-members-list').innerHTML = tripMembers.map(m => `
        <div class="member-chip" style="margin-bottom:6px">
          <div class="avatar" style="width:24px;height:24px;font-size:0.7rem">${(m.name||'?')[0].toUpperCase()}</div>
          ${m.name}
        </div>
      `).join('');
    }
    document.getElementById(id).classList.add('show');
  };

  function copyCode() {
    navigator.clipboard.writeText(currentTrip?.code || '');
    toast('CÃ³digo copiado! ğŸ“‹');
  }

  // â”€â”€â”€ HELPERS â”€â”€â”€
  function openModal(id) { document.getElementById(id).classList.add('show'); }
  function closeModal(id) { document.getElementById(id).classList.remove('show'); }

  document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', e => {
      if (e.target === overlay) overlay.classList.remove('show');
    });
  });

  document.addEventListener('click', e => {
    if (!e.target.closest('.dropdown')) {
      document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('open'));
    }
  });

  function formatAmount(n, currency) {
    const num = Math.round(n);
    if (currency === 'CLP') return '$' + num.toLocaleString('es-CL');
    if (currency === 'EUR') return 'â‚¬' + num.toLocaleString('es-ES', {minimumFractionDigits:0});
    return currency + ' ' + num.toLocaleString('en-US');
  }

  function selectEmoji(el, emoji) {
    selectedEmoji = emoji;
    document.querySelectorAll('#create-trip-modal .cat-btn').forEach(b => b.classList.remove('selected'));
    el.classList.add('selected');
  }

  function selectCat(el, cat, icon) {
    selectedCat = cat;
    selectedCatIcon = icon;
    document.querySelectorAll('.category-grid .cat-btn').forEach(b => b.classList.remove('selected'));
    el.classList.add('selected');
  }

  function friendlyError(code) {
    const map = {
      'auth/invalid-email': 'Correo invÃ¡lido',
      'auth/user-not-found': 'Usuario no encontrado',
      'auth/wrong-password': 'ContraseÃ±a incorrecta',
      'auth/email-already-in-use': 'Correo ya registrado',
      'auth/weak-password': 'ContraseÃ±a muy dÃ©bil (mÃ­nimo 6 caracteres)',
      'auth/invalid-credential': 'Correo o contraseÃ±a incorrectos',
    };
    return map[code] || code;
  }

  let toastTimer;
  function toast(msg) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => el.classList.remove('show'), 2500);
  }
  window.toast = toast;

</script>
</body>
</html>
