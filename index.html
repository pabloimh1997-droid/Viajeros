<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Viajeros ‚Äî Gastos de Viaje</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,wght@0,300;0,600;0,800;1,300&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
  :root {
    --bg: #0a0c10;
    --surface: #111318;
    --surface2: #191d26;
    --surface3: #1f2535;
    --border: rgba(255,255,255,0.07);
    --accent: #e8c97a;
    --accent2: #5b8cf7;
    --accent3: #7cefb0;
    --danger: #f07878;
    --text: #f0ede6;
    --text2: #8a8fa3;
    --text3: #5a5f73;
    --radius: 16px;
    --radius-sm: 10px;
    --shadow: 0 8px 40px rgba(0,0,0,0.5);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  
  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Fondo animado */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: 
      radial-gradient(ellipse 80% 50% at 20% -10%, rgba(91,140,247,0.12) 0%, transparent 60%),
      radial-gradient(ellipse 60% 40% at 80% 110%, rgba(232,201,122,0.08) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  /* ‚îÄ‚îÄ‚îÄ AUTH SCREEN ‚îÄ‚îÄ‚îÄ */
  #auth-screen {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    padding: 20px;
  }

  .auth-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 48px 40px;
    width: 100%;
    max-width: 420px;
    box-shadow: var(--shadow);
    animation: slideUp 0.5s ease;
  }

  .auth-logo {
    text-align: center;
    margin-bottom: 32px;
  }

  .auth-logo h1 {
    font-family: 'Fraunces', serif;
    font-size: 2.4rem;
    font-weight: 800;
    color: var(--accent);
    letter-spacing: -1px;
  }

  .auth-logo p {
    color: var(--text2);
    font-size: 0.9rem;
    margin-top: 4px;
  }

  .auth-tabs {
    display: flex;
    background: var(--surface2);
    border-radius: var(--radius-sm);
    padding: 4px;
    margin-bottom: 28px;
  }

  .auth-tab {
    flex: 1;
    padding: 10px;
    text-align: center;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text2);
    transition: all 0.2s;
  }

  .auth-tab.active {
    background: var(--surface3);
    color: var(--text);
  }

  .form-group { margin-bottom: 16px; }

  .form-group label {
    display: block;
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--text2);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  input, textarea, select {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px 16px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.95rem;
    outline: none;
    transition: border-color 0.2s;
  }

  input:focus, textarea:focus, select:focus {
    border-color: rgba(91,140,247,0.4);
  }

  select option { background: var(--surface2); }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 24px;
    border-radius: var(--radius-sm);
    border: none;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.95rem;
    font-weight: 600;
    transition: all 0.2s;
    text-decoration: none;
  }

  .btn-primary {
    background: var(--accent);
    color: #0a0c10;
    width: 100%;
  }

  .btn-primary:hover { background: #f0d48a; transform: translateY(-1px); }

  .btn-ghost {
    background: transparent;
    color: var(--text2);
    border: 1px solid var(--border);
  }

  .btn-ghost:hover { background: var(--surface2); color: var(--text); }

  .btn-danger {
    background: rgba(240,120,120,0.15);
    color: var(--danger);
    border: 1px solid rgba(240,120,120,0.2);
  }

  .btn-sm { padding: 8px 16px; font-size: 0.85rem; }

  /* ‚îÄ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ‚îÄ */
  #app { display: none; position: relative; z-index: 1; }

  /* ‚îÄ‚îÄ‚îÄ TOP NAV ‚îÄ‚îÄ‚îÄ */
  .topnav {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 50;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 24px;
    background: rgba(10,12,16,0.85);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
  }

  .nav-brand {
    font-family: 'Fraunces', serif;
    font-size: 1.4rem;
    font-weight: 800;
    color: var(--accent);
    letter-spacing: -0.5px;
  }

  .nav-user {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent2), var(--accent));
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.85rem;
    color: #fff;
    flex-shrink: 0;
  }

  .avatar-lg {
    width: 48px;
    height: 48px;
    font-size: 1rem;
  }

  /* ‚îÄ‚îÄ‚îÄ MAIN CONTENT ‚îÄ‚îÄ‚îÄ */
  .main-content {
    padding-top: 80px;
    min-height: 100vh;
  }

  /* ‚îÄ‚îÄ‚îÄ HOME / GROUPS ‚îÄ‚îÄ‚îÄ */
  #home-view {
    padding: 32px 24px;
    max-width: 800px;
    margin: 0 auto;
  }

  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
  }

  .section-title {
    font-family: 'Fraunces', serif;
    font-size: 1.6rem;
    font-weight: 600;
    color: var(--text);
  }

  .section-subtitle {
    color: var(--text2);
    font-size: 0.9rem;
    margin-top: 4px;
  }

  .trip-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 16px;
    cursor: pointer;
    transition: all 0.25s;
    position: relative;
    overflow: hidden;
  }

  .trip-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--accent2), var(--accent));
    opacity: 0;
    transition: opacity 0.25s;
  }

  .trip-card:hover {
    border-color: rgba(91,140,247,0.3);
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(0,0,0,0.3);
  }

  .trip-card:hover::before { opacity: 1; }

  .trip-card-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 12px;
  }

  .trip-emoji {
    font-size: 2rem;
    width: 52px;
    height: 52px;
    background: var(--surface2);
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .trip-info { flex: 1; }

  .trip-name {
    font-family: 'Fraunces', serif;
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 4px;
  }

  .trip-meta {
    display: flex;
    gap: 16px;
    color: var(--text2);
    font-size: 0.85rem;
  }

  .badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.78rem;
    font-weight: 600;
  }

  .badge-blue { background: rgba(91,140,247,0.15); color: var(--accent2); }
  .badge-gold { background: rgba(232,201,122,0.15); color: var(--accent); }
  .badge-green { background: rgba(124,239,176,0.15); color: var(--accent3); }
  .badge-red { background: rgba(240,120,120,0.15); color: var(--danger); }

  /* ‚îÄ‚îÄ‚îÄ TRIP DETAIL ‚îÄ‚îÄ‚îÄ */
  #trip-view {
    display: none;
    max-width: 900px;
    margin: 0 auto;
    padding: 32px 24px;
  }

  .back-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: var(--text2);
    cursor: pointer;
    font-size: 0.9rem;
    margin-bottom: 24px;
    transition: color 0.2s;
  }

  .back-btn:hover { color: var(--text); }

  .trip-hero {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 28px;
    margin-bottom: 24px;
  }

  .trip-hero-top {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 20px;
  }

  .trip-hero-info h2 {
    font-family: 'Fraunces', serif;
    font-size: 1.8rem;
    font-weight: 700;
  }

  .trip-hero-info p { color: var(--text2); font-size: 0.9rem; margin-top: 4px; }

  .members-row {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .member-chip {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 30px;
    padding: 6px 12px;
    font-size: 0.85rem;
  }

  .tabs {
    display: flex;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 6px;
    margin-bottom: 24px;
    gap: 4px;
  }

  .tab {
    flex: 1;
    padding: 10px 16px;
    text-align: center;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text2);
    transition: all 0.2s;
  }

  .tab.active {
    background: var(--surface2);
    color: var(--text);
  }

  /* ‚îÄ‚îÄ‚îÄ EXPENSE CARDS ‚îÄ‚îÄ‚îÄ */
  .expense-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px 24px;
    margin-bottom: 12px;
    transition: all 0.2s;
  }

  .expense-card:hover { border-color: rgba(255,255,255,0.12); }

  .expense-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 12px;
  }

  .expense-icon {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    flex-shrink: 0;
  }

  .expense-details { flex: 1; }

  .expense-title {
    font-weight: 600;
    font-size: 1rem;
    margin-bottom: 4px;
  }

  .expense-meta {
    display: flex;
    gap: 12px;
    font-size: 0.82rem;
    color: var(--text2);
    flex-wrap: wrap;
  }

  .expense-amount {
    text-align: right;
  }

  .expense-amount .total {
    font-family: 'Fraunces', serif;
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--accent);
  }

  .expense-amount .per-person {
    font-size: 0.82rem;
    color: var(--text2);
  }

  /* Payment confirmations */
  .payments-section {
    margin-top: 14px;
    padding-top: 14px;
    border-top: 1px solid var(--border);
  }

  .payments-label {
    font-size: 0.78rem;
    font-weight: 600;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 10px;
  }

  .payment-pills {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .payment-pill {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.82rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid transparent;
  }

  .payment-pill.paid {
    background: rgba(124,239,176,0.15);
    color: var(--accent3);
    border-color: rgba(124,239,176,0.2);
  }

  .payment-pill.unpaid {
    background: var(--surface2);
    color: var(--text2);
    border-color: var(--border);
  }

  .payment-pill.unpaid:hover {
    border-color: rgba(124,239,176,0.3);
    color: var(--accent3);
  }

  .payment-pill .pill-icon { font-size: 0.9rem; }

  /* ‚îÄ‚îÄ‚îÄ BALANCE SECTION ‚îÄ‚îÄ‚îÄ */
  .balance-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 16px;
  }

  .balance-person {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 0;
    border-bottom: 1px solid var(--border);
  }

  .balance-person:last-child { border-bottom: none; }

  .balance-left { display: flex; align-items: center; gap: 12px; }

  .balance-amount {
    font-family: 'Fraunces', serif;
    font-size: 1.2rem;
    font-weight: 600;
  }

  .balance-positive { color: var(--accent3); }
  .balance-negative { color: var(--danger); }
  .balance-neutral { color: var(--text2); }

  /* ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(8px);
    z-index: 200;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    padding: 0;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
  }

  .modal-overlay.show {
    opacity: 1;
    pointer-events: all;
  }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 24px 24px 0 0;
    padding: 32px 28px;
    width: 100%;
    max-width: 560px;
    max-height: 90vh;
    overflow-y: auto;
    transform: translateY(100%);
    transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: 0 -20px 60px rgba(0,0,0,0.5);
  }

  .modal-overlay.show .modal {
    transform: translateY(0);
  }

  .modal-handle {
    width: 40px;
    height: 4px;
    background: var(--surface3);
    border-radius: 2px;
    margin: 0 auto 24px;
  }

  .modal-title {
    font-family: 'Fraunces', serif;
    font-size: 1.4rem;
    font-weight: 600;
    margin-bottom: 24px;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .category-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    margin-bottom: 4px;
  }

  .cat-btn {
    padding: 10px 8px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    text-align: center;
    cursor: pointer;
    font-size: 0.8rem;
    color: var(--text2);
    transition: all 0.2s;
  }

  .cat-btn .cat-icon { font-size: 1.3rem; display: block; margin-bottom: 4px; }

  .cat-btn.selected {
    background: rgba(91,140,247,0.15);
    border-color: rgba(91,140,247,0.4);
    color: var(--accent2);
  }

  /* ‚îÄ‚îÄ‚îÄ MEMBERS CHECKBOXES ‚îÄ‚îÄ‚îÄ */
  .members-check {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .member-check-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all 0.2s;
  }

  .member-check-item.checked {
    border-color: rgba(91,140,247,0.4);
    background: rgba(91,140,247,0.08);
  }

  .check-circle {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    flex-shrink: 0;
    transition: all 0.2s;
  }

  .member-check-item.checked .check-circle {
    background: var(--accent2);
    border-color: var(--accent2);
    color: white;
  }

  /* ‚îÄ‚îÄ‚îÄ FAB ‚îÄ‚îÄ‚îÄ */
  .fab {
    position: fixed;
    bottom: 28px;
    right: 24px;
    width: 58px;
    height: 58px;
    border-radius: 50%;
    background: var(--accent);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    box-shadow: 0 8px 24px rgba(232,201,122,0.3);
    transition: all 0.2s;
    z-index: 40;
    color: #0a0c10;
    font-weight: bold;
  }

  .fab:hover { transform: scale(1.1); box-shadow: 0 12px 32px rgba(232,201,122,0.4); }

  /* ‚îÄ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ‚îÄ */
  .empty-state {
    text-align: center;
    padding: 48px 24px;
    color: var(--text3);
  }

  .empty-state .empty-icon {
    font-size: 3rem;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  .empty-state p { font-size: 1rem; color: var(--text2); }
  .empty-state small { font-size: 0.85rem; }

  /* ‚îÄ‚îÄ‚îÄ INVITE CODE ‚îÄ‚îÄ‚îÄ */
  .invite-box {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-top: 16px;
  }

  .invite-code {
    font-family: monospace;
    font-size: 1.2rem;
    letter-spacing: 3px;
    color: var(--accent);
    font-weight: 700;
  }

  /* ‚îÄ‚îÄ‚îÄ NOTES ‚îÄ‚îÄ‚îÄ */
  .note-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 12px;
  }

  .note-card .note-author {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
  }

  /* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
  .toast {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--surface3);
    border: 1px solid var(--border);
    border-radius: 30px;
    padding: 12px 24px;
    font-size: 0.9rem;
    font-weight: 500;
    z-index: 999;
    opacity: 0;
    transition: all 0.3s;
    pointer-events: none;
    white-space: nowrap;
  }

  .toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  /* ‚îÄ‚îÄ‚îÄ LOADER ‚îÄ‚îÄ‚îÄ */
  .loader {
    width: 20px;
    height: 20px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  .section-panel { display: none; animation: fadeIn 0.3s ease; }
  .section-panel.active { display: block; }

  /* ‚îÄ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ‚îÄ */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 3px; }

  .divider { height: 1px; background: var(--border); margin: 20px 0; }

  .inline-flex { display: inline-flex; align-items: center; gap: 6px; }

  .text-muted { color: var(--text2); font-size: 0.85rem; }
  .text-sm { font-size: 0.85rem; }

  .flex-gap { display: flex; gap: 10px; }

  @media (max-width: 600px) {
    .form-row { grid-template-columns: 1fr; }
    .category-grid { grid-template-columns: repeat(4, 1fr); }
    .auth-card { padding: 36px 24px; }
    .tabs { flex-wrap: wrap; }
  }
</style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="auth-screen">
  <div class="auth-card">
    <div class="auth-logo">
      <h1>‚úà Viajeros</h1>
      <p>Gastos compartidos sin drama</p>
    </div>

    <div class="auth-tabs">
      <div class="auth-tab active" onclick="switchAuthTab('login')">Iniciar sesi√≥n</div>
      <div class="auth-tab" onclick="switchAuthTab('register')">Registrarse</div>
    </div>

    <div id="login-form">
      <div class="form-group">
        <label>Correo electr√≥nico</label>
        <input type="email" id="login-email" placeholder="tu@correo.com">
      </div>
      <div class="form-group">
        <label>Contrase√±a</label>
        <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <button class="btn btn-primary" onclick="doLogin()">Entrar al viaje ‚Üí</button>
    </div>

    <div id="register-form" style="display:none">
      <div class="form-group">
        <label>Tu nombre</label>
        <input type="text" id="reg-name" placeholder="Pablo Mu√±oz">
      </div>
      <div class="form-group">
        <label>Correo electr√≥nico</label>
        <input type="email" id="reg-email" placeholder="tu@correo.com">
      </div>
      <div class="form-group">
        <label>Contrase√±a</label>
        <input type="password" id="reg-password" placeholder="M√≠nimo 6 caracteres">
      </div>
      <button class="btn btn-primary" onclick="doRegister()">Crear cuenta ‚Üí</button>
    </div>

    <div style="margin-top:16px; text-align:center">
      <p class="text-muted">¬øTienes un c√≥digo de viaje?</p>
      <div style="display:flex; gap:8px; margin-top:8px">
        <input type="text" id="join-code" placeholder="C√≥digo de 6 caracteres" style="text-transform:uppercase; letter-spacing:2px">
        <button class="btn btn-ghost btn-sm" onclick="joinByCode()" style="white-space:nowrap">Unirse</button>
      </div>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="app">
  <!-- TOP NAV -->
  <nav class="topnav">
    <div class="nav-brand">‚úà Viajeros</div>
    <div class="nav-user">
      <div class="avatar" id="nav-avatar">?</div>
      <span id="nav-name" style="font-size:0.9rem; color:var(--text2)"></span>
      <button class="btn btn-ghost btn-sm" onclick="doLogout()">Salir</button>
    </div>
  </nav>

  <div class="main-content">
    <!-- HOME VIEW -->
    <div id="home-view">
      <div class="section-header">
        <div>
          <h2 class="section-title">Mis Viajes</h2>
          <p class="section-subtitle">Tus aventuras y sus gastos</p>
        </div>
        <button class="btn btn-primary" style="width:auto" onclick="openModal('create-trip-modal')">+ Nuevo viaje</button>
      </div>
      <div id="trips-list">
        <div class="empty-state">
          <div class="empty-icon">üó∫Ô∏è</div>
          <p>No tienes viajes a√∫n</p>
          <small>Crea uno o √∫nete con un c√≥digo</small>
        </div>
      </div>
    </div>

    <!-- TRIP DETAIL VIEW -->
    <div id="trip-view">
      <div class="back-btn" onclick="goHome()">‚Üê Volver a mis viajes</div>

      <div class="trip-hero">
        <div class="trip-hero-top">
          <div class="trip-emoji" id="tv-emoji" style="font-size:1.8rem; width:60px; height:60px">‚úàÔ∏è</div>
          <div class="trip-hero-info">
            <h2 id="tv-name">Viaje</h2>
            <p id="tv-desc"></p>
          </div>
          <div style="margin-left:auto">
            <button class="btn btn-ghost btn-sm" onclick="openModal('invite-modal')">üë• Invitar</button>
          </div>
        </div>
        <div class="members-row" id="tv-members"></div>
      </div>

      <div class="tabs">
        <div class="tab active" onclick="switchTab('shared')">üí∏ Gastos Compartidos</div>
        <div class="tab" onclick="switchTab('personal')">üîí Mis Gastos</div>
        <div class="tab" onclick="switchTab('balance')">‚öñÔ∏è Balance</div>
        <div class="tab" onclick="switchTab('notes')">üìù Notas</div>
      </div>

      <!-- SHARED EXPENSES -->
      <div class="section-panel active" id="panel-shared">
        <div id="shared-list">
          <div class="empty-state">
            <div class="empty-icon">üí∏</div>
            <p>Sin gastos compartidos a√∫n</p>
            <small>Toca + para agregar el primero</small>
          </div>
        </div>
      </div>

      <!-- PERSONAL EXPENSES -->
      <div class="section-panel" id="panel-personal">
        <div id="personal-list">
          <div class="empty-state">
            <div class="empty-icon">üîí</div>
            <p>Sin gastos personales</p>
            <small>Solo t√∫ puedes verlos</small>
          </div>
        </div>
      </div>

      <!-- BALANCE -->
      <div class="section-panel" id="panel-balance">
        <div class="balance-card">
          <h3 style="font-family:'Fraunces',serif; margin-bottom:16px; color:var(--text2); font-size:1rem; text-transform:uppercase; letter-spacing:1px">Resumen de gastos</h3>
          <div id="balance-list"></div>
        </div>
        <div class="balance-card" id="owed-section" style="margin-top:16px">
          <h3 style="font-family:'Fraunces',serif; margin-bottom:16px; color:var(--text2); font-size:1rem; text-transform:uppercase; letter-spacing:1px">¬øQui√©n le debe a qui√©n?</h3>
          <div id="owed-list"></div>
        </div>
      </div>

      <!-- NOTES -->
      <div class="section-panel" id="panel-notes">
        <div id="notes-list"></div>
        <div style="margin-top:12px">
          <textarea id="note-input" placeholder="Agrega una nota al grupo... (itinerario, recordatorios, ideas)" style="height:80px; resize:none"></textarea>
          <button class="btn btn-primary" style="margin-top:8px; width:auto" onclick="addNote()">Publicar nota</button>
        </div>
      </div>

    </div><!-- /trip-view -->
  </div><!-- /main-content -->

  <!-- FAB -->
  <button class="fab" id="fab-btn" onclick="openAddExpense()" title="Agregar gasto">+</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- CREATE TRIP MODAL -->
<div class="modal-overlay" id="create-trip-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2 class="modal-title">Nuevo Viaje ‚úàÔ∏è</h2>
    <div class="form-group">
      <label>Nombre del viaje</label>
      <input type="text" id="trip-name-input" placeholder="Dolomitas 2025">
    </div>
    <div class="form-group">
      <label>Descripci√≥n</label>
      <input type="text" id="trip-desc-input" placeholder="Un viaje √©pico por los Alpes italianos">
    </div>
    <div class="form-group">
      <label>Emoji del viaje</label>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <span class="cat-btn selected" onclick="selectEmoji(this,'üèîÔ∏è')"><span class="cat-icon">üèîÔ∏è</span></span>
        <span class="cat-btn" onclick="selectEmoji(this,'üèñÔ∏è')"><span class="cat-icon">üèñÔ∏è</span></span>
        <span class="cat-btn" onclick="selectEmoji(this,'üèôÔ∏è')"><span class="cat-icon">üèôÔ∏è</span></span>
        <span class="cat-btn" onclick="selectEmoji(this,'üöó')"><span class="cat-icon">üöó</span></span>
        <span class="cat-btn" onclick="selectEmoji(this,'üõ≥Ô∏è')"><span class="cat-icon">üõ≥Ô∏è</span></span>
        <span class="cat-btn" onclick="selectEmoji(this,'üé≠')"><span class="cat-icon">üé≠</span></span>
        <span class="cat-btn" onclick="selectEmoji(this,'üéø')"><span class="cat-icon">üéø</span></span>
        <span class="cat-btn" onclick="selectEmoji(this,'üå¥')"><span class="cat-icon">üå¥</span></span>
      </div>
    </div>
    <div class="form-group">
      <label>Moneda</label>
      <select id="trip-currency">
        <option value="CLP">CLP ‚Äî Peso Chileno</option>
        <option value="EUR">EUR ‚Äî Euro</option>
        <option value="USD">USD ‚Äî D√≥lar</option>
        <option value="ARS">ARS ‚Äî Peso Argentino</option>
      </select>
    </div>
    <div style="display:flex; gap:10px">
      <button class="btn btn-ghost" style="flex:1" onclick="closeModal('create-trip-modal')">Cancelar</button>
      <button class="btn btn-primary" style="flex:1" onclick="createTrip()">Crear viaje</button>
    </div>
  </div>
</div>

<!-- ADD EXPENSE MODAL -->
<div class="modal-overlay" id="add-expense-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2 class="modal-title" id="expense-modal-title">Agregar Gasto</h2>

    <div class="form-group">
      <label>Tipo</label>
      <div style="display:flex; gap:8px">
        <div class="cat-btn selected" id="type-shared" style="flex:1" onclick="selectExpenseType('shared')">
          <span class="cat-icon">üí∏</span>Compartido
        </div>
        <div class="cat-btn" id="type-personal" style="flex:1" onclick="selectExpenseType('personal')">
          <span class="cat-icon">üîí</span>Personal
        </div>
      </div>
    </div>

    <div class="form-group">
      <label>Descripci√≥n</label>
      <input type="text" id="exp-desc" placeholder="Camper Dolomitas, Cena en Venecia...">
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Monto Total</label>
        <input type="number" id="exp-amount" placeholder="0" min="0">
      </div>
      <div class="form-group" id="paidby-group">
        <label>Pagado por</label>
        <select id="exp-paidby"></select>
      </div>
    </div>

    <div class="form-group">
      <label>Categor√≠a</label>
      <div class="category-grid">
        <div class="cat-btn selected" onclick="selectCat(this,'Alojamiento','üè†')"><span class="cat-icon">üè†</span><small>Alojam.</small></div>
        <div class="cat-btn" onclick="selectCat(this,'Transporte','‚úàÔ∏è')"><span class="cat-icon">‚úàÔ∏è</span><small>Transp.</small></div>
        <div class="cat-btn" onclick="selectCat(this,'Comida','üçΩÔ∏è')"><span class="cat-icon">üçΩÔ∏è</span><small>Comida</small></div>
        <div class="cat-btn" onclick="selectCat(this,'Actividades','üéØ')"><span class="cat-icon">üéØ</span><small>Activid.</small></div>
        <div class="cat-btn" onclick="selectCat(this,'Compras','üõçÔ∏è')"><span class="cat-icon">üõçÔ∏è</span><small>Compras</small></div>
        <div class="cat-btn" onclick="selectCat(this,'Entretenimiento','üéâ')"><span class="cat-icon">üéâ</span><small>Entret.</small></div>
        <div class="cat-btn" onclick="selectCat(this,'Salud','üíä')"><span class="cat-icon">üíä</span><small>Salud</small></div>
        <div class="cat-btn" onclick="selectCat(this,'Otro','üì¶')"><span class="cat-icon">üì¶</span><small>Otro</small></div>
      </div>
    </div>

    <div class="form-group" id="split-group">
      <label>Dividir entre</label>
      <div class="members-check" id="split-members"></div>
    </div>

    <div class="form-group">
      <label>Fecha</label>
      <input type="date" id="exp-date">
    </div>

    <div id="exp-preview" style="display:none; margin-bottom:16px; padding:14px; background:var(--surface2); border-radius:var(--radius-sm); font-size:0.88rem; color:var(--text2)"></div>

    <div style="display:flex; gap:10px">
      <button class="btn btn-ghost" style="flex:1" onclick="closeModal('add-expense-modal')">Cancelar</button>
      <button class="btn btn-primary" style="flex:1" onclick="saveExpense()">Guardar gasto</button>
    </div>
  </div>
</div>

<!-- INVITE MODAL -->
<div class="modal-overlay" id="invite-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2 class="modal-title">Invitar al viaje üë•</h2>
    <p class="text-muted" style="margin-bottom:16px">Comparte este c√≥digo con tus compa√±eros de viaje para que se unan.</p>
    <div class="invite-box">
      <div>
        <div style="font-size:0.78rem; color:var(--text3); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:6px">C√≥digo del viaje</div>
        <div class="invite-code" id="modal-invite-code">------</div>
      </div>
      <button class="btn btn-primary btn-sm" onclick="copyCode()">Copiar</button>
    </div>
    <p class="text-muted" style="margin-top:16px; font-size:0.82rem">
      Los miembros actuales:
    </p>
    <div id="modal-members-list" style="margin-top:8px"></div>
    <button class="btn btn-ghost" style="margin-top:20px; width:100%" onclick="closeModal('invite-modal')">Cerrar</button>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- FIREBASE SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, query, where, onSnapshot, serverTimestamp, arrayUnion, arrayRemove }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // ‚ö†Ô∏è  REEMPLAZA ESTA CONFIGURACI√ìN CON LA TUYA
  //     Ve a console.firebase.google.com ‚Üí Tu proyecto ‚Üí Configuraci√≥n web
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const firebaseConfig = {
    apiKey: "AIzaSyDul4Wf-OzhugXQVrDbSF-kR9YEfqf4kXw",
    authDomain: "viajes-677d5.firebaseapp.com",
    projectId: "viajes-677d5",
    storageBucket: "viajes-677d5.firebasestorage.app",
    messagingSenderId: "195586680424",
    appId: "1:195586680424:web:3d639b746b292faa6e7ddd",
    measurementId: "G-6T1LQ80W25"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ
  let currentUser = null;
  let currentTrip = null;
  let currentTripId = null;
  let selectedEmoji = 'üèîÔ∏è';
  let selectedCat = 'Alojamiento';
  let selectedCatIcon = 'üè†';
  let selectedExpType = 'shared';
  let tripMembers = [];
  let selectedSplitMembers = [];
  let unsubscribeExpenses = null;
  let unsubscribeNotes = null;

  // Expose to global
  window.doLogin = doLogin;
  window.doRegister = doRegister;
  window.doLogout = doLogout;
  window.switchAuthTab = switchAuthTab;
  window.openModal = openModal;
  window.closeModal = closeModal;
  window.createTrip = createTrip;
  window.joinByCode = joinByCode;
  window.goHome = goHome;
  window.switchTab = switchTab;
  window.openTripView = openTripView;
  window.selectEmoji = selectEmoji;
  window.selectCat = selectCat;
  window.selectExpenseType = selectExpenseType;
  window.saveExpense = saveExpense;
  window.togglePayment = togglePayment;
  window.addNote = addNote;
  window.copyCode = copyCode;
  window.openAddExpense = openAddExpense;

  // ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ
  onAuthStateChanged(auth, user => {
    if (user) {
      currentUser = user;
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      document.getElementById('nav-avatar').textContent = user.displayName ? user.displayName[0].toUpperCase() : '?';
      document.getElementById('nav-name').textContent = user.displayName || user.email;
      loadTrips();

      // Check if there's a pending join code
      const pendingCode = localStorage.getItem('pendingJoinCode');
      if (pendingCode) {
        localStorage.removeItem('pendingJoinCode');
        joinByCodeValue(pendingCode);
      }
    } else {
      currentUser = null;
      document.getElementById('auth-screen').style.display = 'flex';
      document.getElementById('app').style.display = 'none';
    }
  });

  async function doLogin() {
    const email = document.getElementById('login-email').value.trim();
    const pass = document.getElementById('login-password').value;
    try {
      await signInWithEmailAndPassword(auth, email, pass);
    } catch(e) {
      toast('Error: ' + friendlyError(e.code));
    }
  }

  async function doRegister() {
    const name = document.getElementById('reg-name').value.trim();
    const email = document.getElementById('reg-email').value.trim();
    const pass = document.getElementById('reg-password').value;
    if (!name) return toast('Ingresa tu nombre');
    try {
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      await updateProfile(cred.user, { displayName: name });
      currentUser = { ...cred.user, displayName: name };
    } catch(e) {
      toast('Error: ' + friendlyError(e.code));
    }
  }

  async function doLogout() {
    await signOut(auth);
  }

  function switchAuthTab(tab) {
    document.querySelectorAll('.auth-tab').forEach((t,i) => t.classList.toggle('active', (i===0 && tab==='login') || (i===1 && tab==='register')));
    document.getElementById('login-form').style.display = tab === 'login' ? 'block' : 'none';
    document.getElementById('register-form').style.display = tab === 'register' ? 'block' : 'none';
  }

  // ‚îÄ‚îÄ‚îÄ TRIPS ‚îÄ‚îÄ‚îÄ
  async function loadTrips() {
    const tripsRef = collection(db, 'trips');
    const q = query(tripsRef, where('memberIds', 'array-contains', currentUser.uid));
    const snap = await getDocs(q);
    const trips = [];
    snap.forEach(d => trips.push({ id: d.id, ...d.data() }));
    renderTrips(trips);
  }

  function renderTrips(trips) {
    const container = document.getElementById('trips-list');
    if (!trips.length) {
      container.innerHTML = `<div class="empty-state"><div class="empty-icon">üó∫Ô∏è</div><p>No tienes viajes a√∫n</p><small>Crea uno o √∫nete con un c√≥digo</small></div>`;
      return;
    }
    container.innerHTML = trips.map(t => `
      <div class="trip-card" onclick="openTripView('${t.id}')">
        <div class="trip-card-header">
          <div class="trip-emoji">${t.emoji || '‚úàÔ∏è'}</div>
          <div class="trip-info">
            <div class="trip-name">${t.name}</div>
            <div class="trip-meta">
              <span>üë• ${t.memberIds?.length || 1} personas</span>
              <span>${t.currency || 'CLP'}</span>
              ${t.description ? `<span>${t.description}</span>` : ''}
            </div>
          </div>
          <span class="badge badge-blue">‚Üí</span>
        </div>
      </div>
    `).join('');
  }

  async function createTrip() {
    const name = document.getElementById('trip-name-input').value.trim();
    const desc = document.getElementById('trip-desc-input').value.trim();
    const currency = document.getElementById('trip-currency').value;
    if (!name) return toast('Ponle nombre al viaje ‚úàÔ∏è');

    const code = Math.random().toString(36).substr(2, 6).toUpperCase();
    const tripData = {
      name,
      description: desc,
      emoji: selectedEmoji,
      currency,
      code,
      createdBy: currentUser.uid,
      memberIds: [currentUser.uid],
      members: [{ uid: currentUser.uid, name: currentUser.displayName || currentUser.email }],
      createdAt: serverTimestamp()
    };
    const ref = await addDoc(collection(db, 'trips'), tripData);
    closeModal('create-trip-modal');
    toast('Viaje creado! üéâ');
    loadTrips();
    setTimeout(() => openTripView(ref.id), 400);
  }

  async function joinByCode() {
    const code = document.getElementById('join-code').value.trim().toUpperCase();
    if (!code) return;
    if (!currentUser) {
      localStorage.setItem('pendingJoinCode', code);
      toast('Inicia sesi√≥n para unirte');
      return;
    }
    await joinByCodeValue(code);
  }

  async function joinByCodeValue(code) {
    const q = query(collection(db, 'trips'), where('code', '==', code));
    const snap = await getDocs(q);
    if (snap.empty) return toast('C√≥digo no encontrado');
    const tripDoc = snap.docs[0];
    const trip = tripDoc.data();
    if (trip.memberIds.includes(currentUser.uid)) return toast('Ya eres miembro de este viaje');
    await updateDoc(doc(db, 'trips', tripDoc.id), {
      memberIds: arrayUnion(currentUser.uid),
      members: arrayUnion({ uid: currentUser.uid, name: currentUser.displayName || currentUser.email })
    });
    toast('¬°Te uniste al viaje! üéâ');
    loadTrips();
    setTimeout(() => openTripView(tripDoc.id), 400);
  }

  // ‚îÄ‚îÄ‚îÄ TRIP VIEW ‚îÄ‚îÄ‚îÄ
  async function openTripView(tripId) {
    const docSnap = await getDoc(doc(db, 'trips', tripId));
    if (!docSnap.exists()) return;
    currentTripId = tripId;
    currentTrip = { id: tripId, ...docSnap.data() };
    tripMembers = currentTrip.members || [];

    document.getElementById('home-view').style.display = 'none';
    document.getElementById('trip-view').style.display = 'block';
    document.getElementById('tv-emoji').textContent = currentTrip.emoji || '‚úàÔ∏è';
    document.getElementById('tv-name').textContent = currentTrip.name;
    document.getElementById('tv-desc').textContent = currentTrip.description || '';

    const membersRow = document.getElementById('tv-members');
    membersRow.innerHTML = tripMembers.map(m => `
      <div class="member-chip">
        <div class="avatar" style="width:28px; height:28px; font-size:0.75rem">${(m.name||'?')[0].toUpperCase()}</div>
        ${m.name}
      </div>
    `).join('');

    switchTab('shared');
    subscribeExpenses();
    subscribeNotes();
  }

  function goHome() {
    document.getElementById('home-view').style.display = 'block';
    document.getElementById('trip-view').style.display = 'none';
    if (unsubscribeExpenses) { unsubscribeExpenses(); unsubscribeExpenses = null; }
    if (unsubscribeNotes) { unsubscribeNotes(); unsubscribeNotes = null; }
    currentTripId = null;
    currentTrip = null;
    loadTrips();
  }

  function switchTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.section-panel').forEach(p => p.classList.remove('active'));
    const tabIndex = ['shared','personal','balance','notes'].indexOf(tab);
    document.querySelectorAll('.tab')[tabIndex].classList.add('active');
    document.getElementById('panel-' + tab).classList.add('active');
    if (tab === 'balance') renderBalance();
    document.getElementById('fab-btn').style.display = (tab === 'balance') ? 'none' : 'flex';
  }

  // ‚îÄ‚îÄ‚îÄ EXPENSES ‚îÄ‚îÄ‚îÄ
  function subscribeExpenses() {
    if (unsubscribeExpenses) unsubscribeExpenses();
    const q = query(collection(db, 'trips', currentTripId, 'expenses'));
    unsubscribeExpenses = onSnapshot(q, snap => {
      const expenses = [];
      snap.forEach(d => expenses.push({ id: d.id, ...d.data() }));
      renderSharedExpenses(expenses.filter(e => e.type === 'shared'));
      renderPersonalExpenses(expenses.filter(e => e.type === 'personal' && e.createdBy === currentUser.uid));
    });
  }

  function renderSharedExpenses(expenses) {
    const container = document.getElementById('shared-list');
    if (!expenses.length) {
      container.innerHTML = `<div class="empty-state"><div class="empty-icon">üí∏</div><p>Sin gastos compartidos a√∫n</p><small>Toca + para agregar el primero</small></div>`;
      return;
    }
    expenses.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
    container.innerHTML = expenses.map(e => renderExpenseCard(e, true)).join('');
  }

  function renderPersonalExpenses(expenses) {
    const container = document.getElementById('personal-list');
    if (!expenses.length) {
      container.innerHTML = `<div class="empty-state"><div class="empty-icon">üîí</div><p>Sin gastos personales</p><small>Solo t√∫ puedes verlos</small></div>`;
      return;
    }
    expenses.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
    container.innerHTML = expenses.map(e => renderExpenseCard(e, false)).join('');
  }

  function renderExpenseCard(e, showPayments) {
    const splitWith = e.splitWith || tripMembers.map(m => m.uid);
    const perPerson = splitWith.length > 0 ? Math.round(e.amount / splitWith.length) : e.amount;
    const currency = currentTrip?.currency || 'CLP';
    const catColors = { Alojamiento:'#5b8cf7', Transporte:'#e8c97a', Comida:'#7cefb0', Actividades:'#f07878', Compras:'#b07cef', Entretenimiento:'#ef9b7c', Salud:'#7cd4ef', Otro:'#8a8fa3' };
    const color = catColors[e.category] || '#5b8cf7';

    let paymentsHtml = '';
    if (showPayments && splitWith.length > 0) {
      const pills = splitWith.map(uid => {
        const member = tripMembers.find(m => m.uid === uid);
        const name = member ? member.name : uid;
        const isPayer = uid === e.paidBy;
        const hasPaid = isPayer || (e.payments && e.payments[uid]);
        const canToggle = uid === currentUser.uid && !isPayer;
        return `<div class="payment-pill ${hasPaid ? 'paid' : 'unpaid'}" 
          ${canToggle ? `onclick="togglePayment('${e.id}','${uid}')"` : ''}
          title="${isPayer ? 'Pagador original' : (hasPaid ? 'Pagado' : 'Pendiente')}">
          <span class="pill-icon">${hasPaid ? '‚úì' : '‚óã'}</span>
          ${name.split(' ')[0]}${isPayer ? ' üí≥' : ''}
        </div>`;
      }).join('');
      paymentsHtml = `<div class="payments-section">
        <div class="payments-label">Confirmaciones de pago</div>
        <div class="payment-pills">${pills}</div>
      </div>`;
    }

    const paidByMember = tripMembers.find(m => m.uid === e.paidBy);
    const paidByName = paidByMember ? paidByMember.name.split(' ')[0] : 'Alguien';

    return `<div class="expense-card">
      <div class="expense-header">
        <div class="expense-icon" style="background:${color}22; color:${color}">${e.categoryIcon || 'üì¶'}</div>
        <div class="expense-details">
          <div class="expense-title">${e.description}</div>
          <div class="expense-meta">
            <span>üí≥ ${paidByName}</span>
            <span>${e.category || 'Otro'}</span>
            <span>${e.date || ''}</span>
            ${showPayments ? `<span>üë• ${splitWith.length} personas</span>` : ''}
          </div>
        </div>
        <div class="expense-amount">
          <div class="total">${formatAmount(e.amount, currency)}</div>
          ${showPayments && splitWith.length > 1 ? `<div class="per-person">${formatAmount(perPerson, currency)} c/u</div>` : ''}
        </div>
      </div>
      ${paymentsHtml}
    </div>`;
  }

  async function togglePayment(expenseId, uid) {
    const expRef = doc(db, 'trips', currentTripId, 'expenses', expenseId);
    const expSnap = await getDoc(expRef);
    if (!expSnap.exists()) return;
    const data = expSnap.data();
    const payments = data.payments || {};
    if (payments[uid]) {
      delete payments[uid];
    } else {
      payments[uid] = true;
    }
    await updateDoc(expRef, { payments });
    toast(payments[uid] !== undefined ? '‚úì Marcado como pagado' : 'Marcado como pendiente');
  }

  // ‚îÄ‚îÄ‚îÄ ADD EXPENSE ‚îÄ‚îÄ‚îÄ
  function openAddExpense() {
    if (!currentTripId) return;
    // Reset form
    document.getElementById('exp-desc').value = '';
    document.getElementById('exp-amount').value = '';
    document.getElementById('exp-date').value = new Date().toISOString().split('T')[0];
    selectedExpType = 'shared';
    selectedCat = 'Alojamiento';
    selectedCatIcon = 'üè†';

    // Populate paidby
    const paidBySelect = document.getElementById('exp-paidby');
    paidBySelect.innerHTML = tripMembers.map(m => `<option value="${m.uid}" ${m.uid === currentUser.uid ? 'selected' : ''}>${m.name}</option>`).join('');

    // Split members
    selectedSplitMembers = tripMembers.map(m => m.uid);
    renderSplitMembers();

    // Reset UI
    document.querySelectorAll('#add-expense-modal .cat-btn').forEach((b,i) => b.classList.toggle('selected', i===0));
    document.getElementById('type-shared').classList.add('selected');
    document.getElementById('type-personal').classList.remove('selected');
    document.getElementById('split-group').style.display = 'block';
    document.getElementById('paidby-group').style.display = 'block';
    document.getElementById('expense-modal-title').textContent = 'Agregar Gasto';

    // Preview updater
    document.getElementById('exp-amount').oninput = updateExpensePreview;

    openModal('add-expense-modal');
  }

  function renderSplitMembers() {
    const container = document.getElementById('split-members');
    container.innerHTML = tripMembers.map(m => {
      const checked = selectedSplitMembers.includes(m.uid);
      return `<div class="member-check-item ${checked ? 'checked' : ''}" onclick="toggleSplitMember('${m.uid}', this)">
        <div class="check-circle">${checked ? '‚úì' : ''}</div>
        <div class="avatar" style="width:28px;height:28px;font-size:0.75rem">${(m.name||'?')[0].toUpperCase()}</div>
        ${m.name}
      </div>`;
    }).join('');
  }

  window.toggleSplitMember = function(uid, el) {
    const idx = selectedSplitMembers.indexOf(uid);
    if (idx > -1) {
      if (selectedSplitMembers.length <= 1) return toast('Debe haber al menos una persona');
      selectedSplitMembers.splice(idx, 1);
      el.classList.remove('checked');
      el.querySelector('.check-circle').textContent = '';
    } else {
      selectedSplitMembers.push(uid);
      el.classList.add('checked');
      el.querySelector('.check-circle').textContent = '‚úì';
    }
    updateExpensePreview();
  };

  function updateExpensePreview() {
    const amount = parseFloat(document.getElementById('exp-amount').value) || 0;
    const preview = document.getElementById('exp-preview');
    if (amount > 0 && selectedExpType === 'shared' && selectedSplitMembers.length > 0) {
      const perPerson = Math.round(amount / selectedSplitMembers.length);
      const currency = currentTrip?.currency || 'CLP';
      preview.style.display = 'block';
      preview.innerHTML = `üí° <strong>${formatAmount(amount, currency)}</strong> total √∑ ${selectedSplitMembers.length} personas = <strong style="color:var(--accent)">${formatAmount(perPerson, currency)} por persona</strong>`;
    } else {
      preview.style.display = 'none';
    }
  }

  function selectExpenseType(type) {
    selectedExpType = type;
    document.getElementById('type-shared').classList.toggle('selected', type === 'shared');
    document.getElementById('type-personal').classList.toggle('selected', type === 'personal');
    document.getElementById('split-group').style.display = type === 'shared' ? 'block' : 'none';
    document.getElementById('paidby-group').style.display = type === 'shared' ? 'block' : 'none';
    updateExpensePreview();
  }

  async function saveExpense() {
    const desc = document.getElementById('exp-desc').value.trim();
    const amount = parseFloat(document.getElementById('exp-amount').value);
    const date = document.getElementById('exp-date').value;
    if (!desc) return toast('Agrega una descripci√≥n');
    if (!amount || amount <= 0) return toast('El monto debe ser mayor a 0');

    const paidBy = selectedExpType === 'shared' ? document.getElementById('exp-paidby').value : currentUser.uid;
    const expData = {
      description: desc,
      amount,
      category: selectedCat,
      categoryIcon: selectedCatIcon,
      date,
      type: selectedExpType,
      paidBy,
      splitWith: selectedExpType === 'shared' ? selectedSplitMembers : [currentUser.uid],
      payments: {},
      createdBy: currentUser.uid,
      createdAt: serverTimestamp()
    };

    await addDoc(collection(db, 'trips', currentTripId, 'expenses'), expData);
    closeModal('add-expense-modal');
    toast('Gasto guardado ‚úì');
    if (selectedExpType !== 'personal') switchTab('shared');
    else switchTab('personal');
  }

  // ‚îÄ‚îÄ‚îÄ BALANCE ‚îÄ‚îÄ‚îÄ
  async function renderBalance() {
    const q = query(collection(db, 'trips', currentTripId, 'expenses'));
    const snap = await getDocs(q);
    const expenses = [];
    snap.forEach(d => expenses.push({ id: d.id, ...d.data() }));

    const sharedExpenses = expenses.filter(e => e.type === 'shared');
    const currency = currentTrip?.currency || 'CLP';

    // Calculate how much each person paid and owes
    const paid = {}; // how much each person paid
    const owes = {}; // how much each person owes
    tripMembers.forEach(m => { paid[m.uid] = 0; owes[m.uid] = 0; });

    sharedExpenses.forEach(e => {
      const splitWith = e.splitWith || tripMembers.map(m => m.uid);
      const perPerson = e.amount / splitWith.length;
      if (paid[e.paidBy] !== undefined) paid[e.paidBy] += e.amount;
      splitWith.forEach(uid => {
        if (owes[uid] !== undefined) owes[uid] += perPerson;
      });
    });

    // Net balance: positive = should receive, negative = should pay
    const net = {};
    tripMembers.forEach(m => { net[m.uid] = paid[m.uid] - owes[m.uid]; });

    const balanceList = document.getElementById('balance-list');
    balanceList.innerHTML = tripMembers.map(m => {
      const n = net[m.uid] || 0;
      const cls = n > 0 ? 'balance-positive' : n < 0 ? 'balance-negative' : 'balance-neutral';
      const label = n > 0 ? 'Le deben' : n < 0 ? 'Debe' : 'Pagado';
      return `<div class="balance-person">
        <div class="balance-left">
          <div class="avatar avatar-lg">${(m.name||'?')[0].toUpperCase()}</div>
          <div>
            <div style="font-weight:600">${m.name}</div>
            <div style="font-size:0.82rem; color:var(--text2)">Pag√≥ ${formatAmount(paid[m.uid]||0, currency)}</div>
          </div>
        </div>
        <div style="text-align:right">
          <div class="balance-amount ${cls}">${n > 0 ? '+' : ''}${formatAmount(n, currency)}</div>
          <div style="font-size:0.78rem; color:var(--text3)">${label}</div>
        </div>
      </div>`;
    }).join('');

    // Calculate who owes whom
    const owedList = document.getElementById('owed-list');
    const debtors = tripMembers.filter(m => net[m.uid] < -1).sort((a,b) => net[a.uid] - net[b.uid]);
    const creditors = tripMembers.filter(m => net[m.uid] > 1).sort((a,b) => net[b.uid] - net[a.uid]);
    
    if (!debtors.length) {
      owedList.innerHTML = '<p style="color:var(--text2); font-size:0.9rem">üéâ ¬°Todos est√°n al d√≠a!</p>';
      return;
    }

    const transactions = [];
    const debtorsCopy = debtors.map(m => ({ ...m, balance: net[m.uid] }));
    const creditorsCopy = creditors.map(m => ({ ...m, balance: net[m.uid] }));

    let i = 0, j = 0;
    while (i < debtorsCopy.length && j < creditorsCopy.length) {
      const amount = Math.min(-debtorsCopy[i].balance, creditorsCopy[j].balance);
      transactions.push({ from: debtorsCopy[i].name, to: creditorsCopy[j].name, amount });
      debtorsCopy[i].balance += amount;
      creditorsCopy[j].balance -= amount;
      if (Math.abs(debtorsCopy[i].balance) < 1) i++;
      if (Math.abs(creditorsCopy[j].balance) < 1) j++;
    }

    owedList.innerHTML = transactions.map(t => `
      <div style="display:flex; align-items:center; gap:8px; padding:12px 0; border-bottom:1px solid var(--border)">
        <div class="avatar" style="width:32px;height:32px;font-size:0.8rem">${t.from[0]}</div>
        <div style="flex:1">
          <strong>${t.from.split(' ')[0]}</strong>
          <span style="color:var(--text2)"> le debe a </span>
          <strong>${t.to.split(' ')[0]}</strong>
        </div>
        <div style="font-family:'Fraunces',serif; color:var(--danger); font-size:1.1rem; font-weight:600">${formatAmount(t.amount, currency)}</div>
      </div>
    `).join('');
  }

  // ‚îÄ‚îÄ‚îÄ NOTES ‚îÄ‚îÄ‚îÄ
  function subscribeNotes() {
    if (unsubscribeNotes) unsubscribeNotes();
    const q = query(collection(db, 'trips', currentTripId, 'notes'));
    unsubscribeNotes = onSnapshot(q, snap => {
      const notes = [];
      snap.forEach(d => notes.push({ id: d.id, ...d.data() }));
      notes.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
      const container = document.getElementById('notes-list');
      if (!notes.length) {
        container.innerHTML = `<div class="empty-state"><div class="empty-icon">üìù</div><p>Sin notas a√∫n</p></div>`;
        return;
      }
      container.innerHTML = notes.map(n => `
        <div class="note-card">
          <div class="note-author">
            <div class="avatar" style="width:28px;height:28px;font-size:0.75rem">${(n.authorName||'?')[0].toUpperCase()}</div>
            <strong style="font-size:0.9rem">${n.authorName}</strong>
            <span class="text-muted">${n.date || ''}</span>
          </div>
          <p style="font-size:0.95rem; line-height:1.6; color:var(--text)">${n.content}</p>
        </div>
      `).join('');
    });
  }

  async function addNote() {
    const content = document.getElementById('note-input').value.trim();
    if (!content) return;
    await addDoc(collection(db, 'trips', currentTripId, 'notes'), {
      content,
      authorId: currentUser.uid,
      authorName: currentUser.displayName || currentUser.email,
      date: new Date().toLocaleDateString('es-CL'),
      createdAt: serverTimestamp()
    });
    document.getElementById('note-input').value = '';
    toast('Nota publicada ‚úì');
  }

  // ‚îÄ‚îÄ‚îÄ INVITE ‚îÄ‚îÄ‚îÄ
  window.openModal = function(id) {
    if (id === 'invite-modal' && currentTrip) {
      document.getElementById('modal-invite-code').textContent = currentTrip.code;
      document.getElementById('modal-members-list').innerHTML = tripMembers.map(m => `
        <div class="member-chip" style="margin-bottom:6px">
          <div class="avatar" style="width:24px;height:24px;font-size:0.7rem">${(m.name||'?')[0].toUpperCase()}</div>
          ${m.name}
        </div>
      `).join('');
    }
    document.getElementById(id).classList.add('show');
  };

  function copyCode() {
    navigator.clipboard.writeText(currentTrip?.code || '');
    toast('C√≥digo copiado! üìã');
  }

  // ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ
  function openModal(id) { document.getElementById(id).classList.add('show'); }
  function closeModal(id) { document.getElementById(id).classList.remove('show'); }

  document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', e => {
      if (e.target === overlay) overlay.classList.remove('show');
    });
  });

  function formatAmount(n, currency) {
    const num = Math.round(n);
    if (currency === 'CLP') return '$' + num.toLocaleString('es-CL');
    if (currency === 'EUR') return '‚Ç¨' + num.toLocaleString('es-ES', {minimumFractionDigits:0});
    return currency + ' ' + num.toLocaleString('en-US');
  }

  function selectEmoji(el, emoji) {
    selectedEmoji = emoji;
    document.querySelectorAll('#create-trip-modal .cat-btn').forEach(b => b.classList.remove('selected'));
    el.classList.add('selected');
  }

  function selectCat(el, cat, icon) {
    selectedCat = cat;
    selectedCatIcon = icon;
    document.querySelectorAll('.category-grid .cat-btn').forEach(b => b.classList.remove('selected'));
    el.classList.add('selected');
  }

  function friendlyError(code) {
    const map = {
      'auth/invalid-email': 'Correo inv√°lido',
      'auth/user-not-found': 'Usuario no encontrado',
      'auth/wrong-password': 'Contrase√±a incorrecta',
      'auth/email-already-in-use': 'Correo ya registrado',
      'auth/weak-password': 'Contrase√±a muy d√©bil (m√≠nimo 6 caracteres)',
      'auth/invalid-credential': 'Correo o contrase√±a incorrectos',
    };
    return map[code] || code;
  }

  let toastTimer;
  function toast(msg) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => el.classList.remove('show'), 2500);
  }
  window.toast = toast;

</script>
</body>
</html>
